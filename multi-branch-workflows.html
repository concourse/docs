<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=775" />
<title>Multi-Branch Workflows - Concourse CI</title>
<link rel="stylesheet" type="text/css" href="css/normalize.css" />
<link rel="stylesheet" type="text/css" href="css/pipeline.css" />
<link rel="stylesheet" type="text/css" href="css/iosevka.css" />
<link rel="stylesheet" type="text/css" href="css/booklit.css" />
<link rel="stylesheet" type="text/css" href="css/prism.css" />
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
<link href="https://fonts.googleapis.com/css?family=Barlow:400,400i,700|Roboto+Slab:300,400,700" rel="stylesheet" />
<script src="js/search.js"></script>
<script async type="text/javascript" src="js/prism.js"></script>
<script data-goatcounter="https://concourse.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  </head>
  <body>
    <div class="top-banner">
  <p class="banner-text">
    ðŸŽ‰<a href="https://blog.concourse-ci.org/posts/2025-04-03-7-13-release-and-project-update/">v7.13.0 Release and Project Update</a> âœ¨
  </p>
</div>

<div class="page-top">
  <nav class="top-nav">
    <a class="top-link logo-link" href="/"><img src="images/logo-white.svg" />Concourse</a>
    
    <a class="top-link active" href="docs.html">Docs</a>
    
    <a class="top-link" href="examples.html">Examples</a>
    
    <a class="top-link" href="project.html">Project</a>
    
    <a class="top-link" href="ecosystem.html">Ecosystem</a>
    
    <a class="top-link" href="https://resource-types.concourse-ci.org">Resource Types</a>
    <a class="top-link" href="https://blog.concourse-ci.org">blog</a>
    <a class="top-link" href="https://github.com/concourse/concourse/discussions">discuss</a>

    <div id="search"></div>

    <script type="text/javascript">
      var app = Elm.Main.init({
        node: document.getElementById('search')
      });

      app.ports.emitSearchTerm.subscribe(function(term) {
        goatcounter.count({
          path: "search:" + term,
          title: "user searched: " + term,
          event: true
        });
      });
    </script>
  </nav>
</div>

    <div class="page-body">
      <div class="page-nav">
        






  
  
  
  
  
  
  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1</span><a href="docs.html"  class="active">Docs</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.1</td>
            <td class="title-cell"><a href="getting-started.html" >Getting Started</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.2</td>
            <td class="title-cell"><a href="install.html" >Install</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.3</td>
            <td class="title-cell"><a href="auth.html" >Auth &amp; Teams</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.4</td>
            <td class="title-cell"><a href="fly.html" >The <code>fly</code> CLI</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.5</td>
            <td class="title-cell"><a href="config-basics.html" >Config Basics</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.6</td>
            <td class="title-cell"><a href="pipelines.html" >Pipelines</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.7</td>
            <td class="title-cell"><a href="vars.html" >Vars</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.8</td>
            <td class="title-cell"><a href="resources.html" >Resources</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.9</td>
            <td class="title-cell"><a href="resource-types.html" >Resource Types</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.10</td>
            <td class="title-cell"><a href="jobs.html" >Jobs</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.11</td>
            <td class="title-cell"><a href="steps.html" >Steps</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.12</td>
            <td class="title-cell"><a href="tasks.html" >Tasks</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.13</td>
            <td class="title-cell"><a href="builds.html" >Builds</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.14</td>
            <td class="title-cell"><a href="how-to-guides.html"  class="active">How-To Guides</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15</td>
            <td class="title-cell"><a href="operation.html" >Operation</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.16</td>
            <td class="title-cell"><a href="observation.html" >Observation</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.17</td>
            <td class="title-cell"><a href="internals.html" >Internals</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  

  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1.14</span><a href="how-to-guides.html"  class="active">How-To Guides</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.14.1</td>
            <td class="title-cell"><a href="pipeline-guides.html" >Pipeline Guides</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.14.2</td>
            <td class="title-cell"><a href="git-guides.html"  class="active">Git Guides</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.14.3</td>
            <td class="title-cell"><a href="container-image-guides.html" >Container Image Guides</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  

  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1.14.2</span><a href="git-guides.html"  class="active">Git Guides</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.14.2.1</td>
            <td class="title-cell"><a href="basic-git-operations.html" >Basic Git Operations</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.14.2.2</td>
            <td class="title-cell"><a href="multi-branch-workflows.html"  class="self">Multi-Branch Workflows</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  

  

  



      </div>

      <div class="body-content">
        <div class="page-content">
          <div class="section" id="section_multi-branch-workflows">
  
  <h1 class="section-header"><a class="anchor-target" name="multi-branch-workflows" href="#multi-branch-workflows"></a><span class="section-number">1.14.2.2 </span>Multi-Branch Workflows</h1>
  

  <p>Teams may make use of multiple branches for their development. For instance, some teams create feature branches while working on new functionality - once this functionality is ready, the branch will be merged into the main branch and the feature branch will be deleted.</p><p>While a feature is under development, you&#39;ll often want to run tests against the feature branch and possibly deploy to a staging environment. To model this in Concourse, you&#39;ll need to have a pipeline for each active feature branch. Manually setting (and eventually archiving) a pipeline for each feature branch would be quite a burden. For this type of workflow, Concourse has a few important tools to help you out: the <a href="set-pipeline-step.html"><code>set_pipeline</code> step</a>, <a href="across-step.html#schema.across"><code class="schema-attribute-name"><bold>across</bold></code></a>, and <a href="instanced-pipelines.html">instanced pipelines</a>.</p><div class="warning">
  <p><a href="across-step.html#schema.across"><code class="schema-attribute-name"><bold>across</bold></code></a> and <a href="instanced-pipelines.html">instanced pipelines</a> are both experimental features, and must be enabled with the feature flags <code>CONCOURSE_ENABLE_ACROSS_STEP</code> and <code>CONCOURSE_ENABLE_PIPELINE_INSTANCES</code>, respectively.</p>
</div><p>In this guide, we&#39;ll cover:</p><ol>

  <li><p>Writing a pipeline to <a href="multi-branch-workflows.html#multi-branch-test-build-deploy">Test, Build &amp; Deploy</a> a branch to a staging environment. We&#39;ll use <a href="https://www.terraform.io/">Terraform</a> for our deployment</p></li>

  <li><p><a href="multi-branch-workflows.html#multi-branch-tracking-branches">Tracking Branches</a> in a repository; for each branch, we&#39;ll set a pipeline (using the <a href="set-pipeline-step.html"><code>set_pipeline</code> step</a> and <a href="across-step.html#schema.across"><code class="schema-attribute-name"><bold>across</bold></code></a>)</p></li>

  <li><p>Automatically <a href="multi-branch-workflows.html#multi-branch-cleaning-up">Cleaning Up Old Workspaces</a> after branches get merged or deleted</p></li>

</ol>

  
    
      <div class="section" id="section_multi-branch-test-build-deploy">
  
  <h2 class="section-header"><a class="anchor-target" name="multi-branch-test-build-deploy" href="#multi-branch-test-build-deploy"></a>Test, Build &amp; Deploy</h2>
  

  <p>We&#39;ll start out by defining the pipeline that should run for each active branch. For this example, we&#39;ll be working with the following <a href="https://github.com/concourse/examples/tree/master/apps/golang">sample Go application</a>.</p><p>Our pipeline will have three stages:</p><ol>

  <li><p>Run unit tests</p></li>

  <li><p>Build and upload a binary to a blobstore (in our case, we&#39;ll use <a href="https://cloud.google.com/storage">Google Cloud Storage</a>)</p></li>

  <li><p>Trigger a <code>terraform apply</code> to deploy our app to a staging environment. The <a href="https://github.com/concourse/examples/blob/master/terraform/staging/main.tf">Terraform module</a> we&#39;ll use here doesn&#39;t actually provision any infrastructure, and is just used as an example</p></li>

</ol><p>Since the pipeline config is intended to be used as a template for multiple different branches, we can use <a href="vars.html">Vars</a> to parameterize the config. In particular, we&#39;ll use the vars <code>((feature))</code> and <code>((branch))</code>, which represent the name of the feature and the name of the branch, respectively.</p><p>Below is the full pipeline config:</p><p><a href="https://github.com/concourse/examples/blob/master/pipelines/multi-branch/template.yml"><code>examples/pipelines/multi-branch/template.yml</code></a> <pre><code class="language-yaml">resource_types:
- name: terraform
  type: registry-image
  source:
    repository: ljfranklin/terraform-resource

- name: gcs
  type: registry-image
  source:
    repository: frodenas/gcs-resource

resources:
- name: branch
  type: git
  source:
    uri: https://github.com/concourse/examples
    branch: ((branch))

- name: examples
  type: git
  source:
    uri: https://github.com/concourse/examples

- name: build-artifact
  type: gcs
  source:
    bucket: concourse-examples
    json_key: ((gcp_service_account_key))
    regexp: multi-branch/features/((feature))/my-app-(.&#43;)\.tgz

- name: staging-env
  type: terraform
  source:
    env_name: ((feature))
    backend_type: gcs
    backend_config:
      bucket: concourse-examples
      prefix: multi-branch/terraform
      credentials: ((gcp_service_account_key))

jobs:
- name: test
  plan:
  - in_parallel:
    - get: branch
      trigger: true
    - get: examples
  - task: unit
    file: examples/tasks/go-test.yml
    input_mapping: {repo: branch}
    params: {MODULE: apps/golang}

- name: build
  plan:
  - in_parallel:
    - get: branch
      passed: [test]
      trigger: true
    - get: examples
  - task: build
    file: examples/tasks/go-build.yml
    params:
      MODULE: apps/golang
      BINARY_NAME: my-app
    input_mapping: {repo: branch}
  - put: build-artifact
    params: {file: &#34;binary/my-app-*.tgz&#34;}

- name: deploy
  plan:
  - in_parallel:
    - get: build-artifact
      passed: [build]
      trigger: true
    - get: examples
  - load_var: bundle_url
    file: build-artifact/url
  - put: staging-env
    params:
      terraform_source: examples/terraform/staging
      vars: {bundle_url: ((.:bundle_url))}
</code></pre></p>

  
    
  
</div>
    
      <div class="section" id="section_multi-branch-tracking-branches">
  
  <h2 class="section-header"><a class="anchor-target" name="multi-branch-tracking-branches" href="#multi-branch-tracking-branches"></a>Tracking Branches</h2>
  

  <p>In addition to the branch pipeline template, we&#39;ll also need a pipeline to track the list of branches and set a pipeline for each one.</p><p>To track the list of branches in a repository, we can use <a href="https://github.com/aoldershaw/git-branches-resource">aoldershaw/git-branches-resource</a>. This <a href="resource-types.html"><code>resource_type</code></a> emits a new <a href="resource-versions.html">resource version</a> whenever a branch is created or deleted. It also lets us filter the list of branches by a regular expression. In this case, let&#39;s assume our feature branches match the regular expression <code>feature/.*</code>.</p><p>Below is the full pipeline config for this tracker pipeline:</p><p><a href="https://github.com/concourse/examples/blob/master/pipelines/multi-branch/tracker.yml"><code>examples/pipelines/multi-branch/tracker.yml</code></a> <pre><code class="language-yaml">resource_types:
- name: git-branches
  type: registry-image
  source:
    repository: aoldershaw/git-branches-resource

resources:
- name: feature-branches
  type: git-branches
  source:
    uri: https://github.com/concourse/examples
    # The &#34;(?P&lt;name&gt;pattern)&#34; syntax defines a named capture group.
    # aoldershaw/git-branches-resource emits the value of each named capture
    # group under the `groups` key.
    #
    # e.g. feature/some-feature ==&gt; {&#34;groups&#34;: {&#34;feature&#34;: &#34;some-feature&#34;}}
    branch_regex: &#39;feature/(?P&lt;feature&gt;.*)&#39;

- name: examples
  type: git
  source:
    uri: https://github.com/concourse/examples

jobs:
- name: set-feature-pipelines
  plan:
  - in_parallel:
    - get: feature-branches
      trigger: true
    - get: examples
  - load_var: branches
    file: feature-branches/branches.json
  - across:
    - var: branch
      values: ((.:branches))
    set_pipeline: dev
    file: examples/pipelines/multi-branch/template.yml
    instance_vars: {feature: ((.:branch.groups.feature))}
    vars: {branch: ((.:branch.name))}</code></pre></p><p>We set each pipeline as an <a href="instanced-pipelines.html">instanced pipeline</a> - this will result in Concourse grouping all of the related <code>dev</code> pipelines in the UI.</p>

  
    
  
</div>
    
      <div class="section" id="section_multi-branch-cleaning-up">
  
  <h2 class="section-header"><a class="anchor-target" name="multi-branch-cleaning-up" href="#multi-branch-cleaning-up"></a>Cleaning Up Old Workspaces</h2>
  

  <p>With the setup described in <a href="multi-branch-workflows.html#multi-branch-tracking-branches">Tracking Branches</a>, Concourse will automatically archive any pipelines for branches that get removed. However, Concourse doesn&#39;t know that it should destroy Terraform workspaces when a branch is removed. To accomplish this, we can yet again make use of the <a href="https://github.com/ljfranklin/terraform-resource">Terraform resource</a> to destroy these workspaces. We&#39;ll add another job to the tracker pipeline that figures out which workspaces don&#39;t belong to an active branch and destroy them.</p><p><a href="https://github.com/concourse/examples/blob/master/pipelines/multi-branch/tracker.yml"><code>examples/pipelines/multi-branch/tracker.yml</code></a> <pre><code class="language-yaml">resource_types:
- name: git-branches
  ...

- name: terraform
  type: registry-image
  source:
    repository: ljfranklin/terraform-resource

resources:
- name: feature-branches
  ...

- name: examples
  ...

- name: staging-env
  type: terraform
  source:
    backend_type: gcs
    backend_config: &amp;terraform_backend_config
      bucket: concourse-examples
      prefix: multi-branch/terraform
      credentials: ((gcp_service_account_key))

jobs:
- name: set-feature-pipelines
  ...

- name: cleanup-inactive-workspaces
  plan:
  - in_parallel:
    - get: feature-branches
      passed: [set-feature-pipelines]
      trigger: true
    - get: examples
  - task: find-inactive-workspaces
    config:
      platform: linux
      image_resource:
        type: registry-image
        source: {repository: hashicorp/terraform}
      inputs:
      - name: feature-branches
      outputs:
      - name: extra-workspaces
      params:
        TERRAFORM_BACKEND_CONFIG:
          gcs: *terraform_backend_config
      run:
        path: sh
        args:
        - -c
        - |
          set -euo pipefail

          apk add -q jq

          active_features=&#34;$(jq &#39;[.[].groups.feature]&#39; feature-branches/branches.json)&#34;

          jq -n &#34;{terraform: {backend: $TERRAFORM_BACKEND_CONFIG}}&#34; &gt; backend.tf.json
          terraform init

          # List all active workspaces, ignoring the default workspace
          active_workspaces=&#34;$(terraform workspace list | grep -v &#39;^[*]&#39; | tr -d &#39; &#39; | jq --raw-input --slurp &#39;split(&#34;\n&#34;) | map(select(. != &#34;&#34;))&#39;)&#34;

          jq -n &#34;$active_workspaces - $active_features&#34; &gt; extra-workspaces/workspaces.json
  - load_var: extra_workspaces
    file: extra-workspaces/workspaces.json
  - across:
    - var: workspace
      values: ((.:extra_workspaces))
    put: staging-env
    params:
      terraform_source: examples/terraform/staging
      env_name: ((.:workspace))
      action: destroy
    get_params:
      action: destroy</code></pre></p>

  
    
  
</div>
    
  
</div>

          <nav class="prev-next">
          
            <div class="prev">
              prev:

              
              <span class="section-number">1.14.2.1</span>
              

              <a href="basic-git-operations.html">Basic Git Operations</a>
            </div>
          

          
            <div class="next">
              next:

              
              <span class="section-number">1.14.3</span>
              

              <a href="container-image-guides.html">Container Image Guides</a>
            </div>
          
          </nav>
        </div>

        <div class="page-aside"></div>
      </div>
    </div>

    <ul class="improve-docs">
      <li><img src="images/icons/github-box.svg" /> <a href="https://github.com/concourse/docs">help improve this site</a></li>
      <li><img src="images/booklit.svg" /> powered by <a href="https://vito.github.io/booklit">Booklit</a></li>
    </ul>
  </body>
</html>