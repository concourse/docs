<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=775" />
<title>Internals - Concourse CI</title>
<link rel="stylesheet" type="text/css" href="css/normalize.css" />
<link rel="stylesheet" type="text/css" href="css/pipeline.css" />
<link rel="stylesheet" type="text/css" href="css/iosevka.css" />
<link rel="stylesheet" type="text/css" href="css/booklit.css" />
<link rel="stylesheet" type="text/css" href="css/prism.css" />
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
<link href="https://fonts.googleapis.com/css?family=Barlow:400,400i,700|Roboto+Slab:300,400,700" rel="stylesheet" />
<script src="js/search.js"></script>
<script async type="text/javascript" src="js/prism.js"></script>
<script data-goatcounter="https://concourse.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  </head>
  <body>
    <div class="top-banner">
  <p class="banner-text">
    ✨ The <a href="https://airtable.com/shrp01n9DwRSIz4vk">2021 Concourse CI Community Survey</a> is now live! ✨
  </p>
</div>

<div class="page-top">
  <nav class="top-nav">
    <a class="top-link logo-link" href="/"><img src="images/logo-white.svg" />Concourse</a>
    
    <a class="top-link active" href="docs.html">Docs</a>
    
    <a class="top-link" href="examples.html">Examples</a>
    
    <a class="top-link" href="project.html">Project</a>
    
    <a class="top-link" href="https://resource-types.concourse-ci.org">Resource Types</a>
    <a class="top-link" href="https://blog.concourse-ci.org">blog</a>
    <a class="top-link" href="https://github.com/concourse/concourse/discussions">discuss</a>

    <div id="search"></div>

    <script type="text/javascript">
      var app = Elm.Main.init({
        node: document.getElementById('search')
      });

      app.ports.emitSearchTerm.subscribe(function(term) {
        goatcounter.count({
          path: "search:" + term,
          title: "user searched: " + term,
          event: true
        });
      });
    </script>
  </nav>
</div>

    <div class="page-body">
      <div class="page-nav">
        






  
  
  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1</span><a href="docs.html"  class="active">Docs</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.1</td>
            <td class="title-cell"><a href="install.html" >Install</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.2</td>
            <td class="title-cell"><a href="auth.html" >Auth &amp; Teams</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.3</td>
            <td class="title-cell"><a href="fly.html" >The <code>fly</code> CLI</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.4</td>
            <td class="title-cell"><a href="config-basics.html" >Config Basics</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.5</td>
            <td class="title-cell"><a href="pipelines.html" >Pipelines</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.6</td>
            <td class="title-cell"><a href="vars.html" >Vars</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.7</td>
            <td class="title-cell"><a href="resources.html" >Resources</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.8</td>
            <td class="title-cell"><a href="resource-types.html" >Resource Types</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.9</td>
            <td class="title-cell"><a href="jobs.html" >Jobs</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.10</td>
            <td class="title-cell"><a href="tasks.html" >Tasks</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.11</td>
            <td class="title-cell"><a href="builds.html" >Builds</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.12</td>
            <td class="title-cell"><a href="operation.html" >Operation</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.13</td>
            <td class="title-cell"><a href="observation.html" >Observation</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.14</td>
            <td class="title-cell"><a href="internals.html"  class="self">Internals</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  

  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1.14</span><a href="internals.html"  class="self">Internals</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.14.1</td>
            <td class="title-cell"><a href="internals.html#basic-architecture" >Basic architecture</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.14.2</td>
            <td class="title-cell"><a href="internals.html#component-atc" >ATC: web UI &amp; build scheduler</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.14.3</td>
            <td class="title-cell"><a href="internals.html#component-tsa" >TSA: worker registration &amp; forwarding</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.14.4</td>
            <td class="title-cell"><a href="internals.html#architecture-worker" >Workers: container runtime &amp; cache management</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  



<div class="context">
  <div class="Top">
    On this page:
  </div>

  <div class="children anchors">
    <table>
      

      
  
    
      <tr>
        <td class="number-cell">1.14.1</td>
        <td class="title-cell"><a href="internals.html#basic-architecture" >Basic architecture</a></td>
      </tr>
      
      
  
    
  

    
      <tr>
        <td class="number-cell">1.14.2</td>
        <td class="title-cell"><a href="internals.html#component-atc" >ATC: web UI &amp; build scheduler</a></td>
      </tr>
      
      
  

    
      <tr>
        <td class="number-cell">1.14.3</td>
        <td class="title-cell"><a href="internals.html#component-tsa" >TSA: worker registration &amp; forwarding</a></td>
      </tr>
      
      
  
    
  

    
      <tr>
        <td class="number-cell">1.14.4</td>
        <td class="title-cell"><a href="internals.html#architecture-worker" >Workers: container runtime &amp; cache management</a></td>
      </tr>
      
      
  
    
      <tr>
        <td class="number-cell">1.14.4.1</td>
        <td class="title-cell"><a href="internals.html#worker-lifecycle" >The worker lifecycle</a></td>
      </tr>
      
        <tr>
          <td class="number-cell"><code>#</code></td>
          <td class="title-cell"><a href="internals.html#RUNNING-table"><code><strong>RUNNING</strong></code></a></td>
        </tr>
      
        <tr>
          <td class="number-cell"><code>#</code></td>
          <td class="title-cell"><a href="internals.html#STALLED-table"><code><strong>STALLED</strong></code></a></td>
        </tr>
      
        <tr>
          <td class="number-cell"><code>#</code></td>
          <td class="title-cell"><a href="internals.html#LANDING-table"><code><strong>LANDING</strong></code></a></td>
        </tr>
      
        <tr>
          <td class="number-cell"><code>#</code></td>
          <td class="title-cell"><a href="internals.html#LANDED-table"><code><strong>LANDED</strong></code></a></td>
        </tr>
      
        <tr>
          <td class="number-cell"><code>#</code></td>
          <td class="title-cell"><a href="internals.html#RETIRING-table"><code><strong>RETIRING</strong></code></a></td>
        </tr>
      
      
  
    
  

    
  

    
  

    </table>
  </div>
</div>

      </div>

      <div class="body-content">
        <div class="page-content">
          <div class="section" id="section_internals">
  
  <h1 class="section-header"><a class="anchor-target" name="internals" href="#internals"></a><span class="section-number">1.14 </span>Internals</h1>
  

  <p>This section provides a deeper understanding of some of the concepts surrounding Concourse.</p><p>An understanding of the basics of Concourse concepts, such as pipelines, jobs, etc, is recommended as parts of this section might assume a level of knowledge from them. This section is not necessary for using Concourse but are more for experienced users that want to dig deeper into how Concourse works.</p><div class="table-of-contents">
  <span class="toc-header">Table of contents:</span>

  
  
  <ol class="toc">
  
    <li>
      <span class="section-number">1.14.1</span>
      <a href="internals.html#basic-architecture">Basic architecture</a>

      
  
  
    </li>
  
    <li>
      <span class="section-number">1.14.2</span>
      <a href="internals.html#component-atc">ATC: web UI &amp; build scheduler</a>

      
  
  <ol class="toc">
  
    <li>
      <span class="section-number">1.14.2.1</span>
      <a href="checker.html">Resource Checker</a>

      
  
  
    </li>
  
    <li>
      <span class="section-number">1.14.2.2</span>
      <a href="scheduler.html">Build Scheduler</a>

      
  
  
    </li>
  
    <li>
      <span class="section-number">1.14.2.3</span>
      <a href="build-tracker.html">Build Tracker</a>

      
  
  
    </li>
  
    <li>
      <span class="section-number">1.14.2.4</span>
      <a href="garbage-collector.html">Garbage Collector</a>

      
  
  
    </li>
  
  </ol>
  
  
    </li>
  
    <li>
      <span class="section-number">1.14.3</span>
      <a href="internals.html#component-tsa">TSA: worker registration &amp; forwarding</a>

      
  
  
    </li>
  
    <li>
      <span class="section-number">1.14.4</span>
      <a href="internals.html#architecture-worker">Workers: container runtime &amp; cache management</a>

      
  
  <ol class="toc">
  
    <li>
      <span class="section-number">1.14.4.1</span>
      <a href="internals.html#worker-lifecycle">The worker lifecycle</a>

      
  
  
    </li>
  
  </ol>
  
  
    </li>
  
  </ol>
  
  
</div>

  
    
      <div class="section" id="section_basic-architecture">
  
  <h2 class="section-header"><a class="anchor-target" name="basic-architecture" href="#basic-architecture"></a>Basic architecture</h2>
  

  <p>Concourse is a fairly simple distributed system built up from the following components. You&#39;ll see them referenced here and there throughout the documentation, so you may want to skim this page just to get an idea of what they are.</p><div class="diagram">
  <img src="images/concourse_architecture.png" alt="diagram" width="80%" />
</div>

  
    
  
</div>
    
      <div class="section" id="section_component-atc">
  
  <h2 class="section-header"><a class="anchor-target" name="component-atc" href="#component-atc"></a>ATC: web UI &amp; build scheduler</h2>
  

  <p>The ATC is the heart of Concourse. It runs the web UI and API and is responsible for all pipeline scheduling. It connects to PostgreSQL, which it uses to store pipeline data (including build logs).</p><p>Multiple ATCs can be running as one cluster; as long as they&#39;re all pointing to the same database, they&#39;ll synchronize using basic locking mechanisms and roughly spread work across the cluster.</p><p>The ATC by default listens on port <code>8080</code>, and is usually colocated with the <a href="internals.html#component-tsa">TSA</a> and sitting behind a load balancer.</p><p><strong>Note:</strong> for <a href="builds.html#fly-intercept"><code>fly intercept</code></a> to function, make sure your load balancer is configured to do TCP or SSL forwarding, not HTTP or HTTPS.</p><p>There are multiple components within the ATC that each have their own set of responsibilities. The main components consist of the <a href="checker.html">checker</a>, <a href="scheduler.html">scheduler</a>, <a href="build-tracker.html">build tracker</a> and the <a href="garbage-collector.html">garbage collector</a>.</p><p>The <a href="checker.html">checker</a>&#39;s responsibility is to continously checks for new versions of resources. The <a href="scheduler.html">scheduler</a> is responsible for scheduling builds for a job and the <a href="build-tracker.html">build tracker</a> is responsible for running any scheduled builds. The <a href="garbage-collector.html">garbage collector</a> is the cleanup mechanism for removing any unused or outdated objects, such as containers and volumes.</p><div class="table-of-contents">
  <span class="toc-header">Table of contents:</span>

  
  
  <ol class="toc">
  
    <li>
      <span class="section-number">1.14.2.1</span>
      <a href="checker.html">Resource Checker</a>

      
  
  
    </li>
  
    <li>
      <span class="section-number">1.14.2.2</span>
      <a href="scheduler.html">Build Scheduler</a>

      
  
  
    </li>
  
    <li>
      <span class="section-number">1.14.2.3</span>
      <a href="build-tracker.html">Build Tracker</a>

      
  
  
    </li>
  
    <li>
      <span class="section-number">1.14.2.4</span>
      <a href="garbage-collector.html">Garbage Collector</a>

      
  
  
    </li>
  
  </ol>
  
  
</div><p>All the components in a Concourse deployment can be viewed in the <em>components</em> table in the database as of v5.7.0. The intervals that the components run at can also be adjusted through editing that table, as well as pausing the component from running entirely.</p>

  
</div>
    
      <div class="section" id="section_component-tsa">
  
  <h2 class="section-header"><a class="anchor-target" name="component-tsa" href="#component-tsa"></a>TSA: worker registration &amp; forwarding</h2>
  

  <p>The TSA is a custom-built SSH server that is used solely for securely registering <a href="internals.html#architecture-worker">workers</a> with the <a href="internals.html#component-atc">ATC</a>.</p><p>The TSA by default listens on port <code>2222</code>, and is usually colocated with the <a href="internals.html#component-atc">ATC</a> and sitting behind a load balancer.</p><p>The TSA implements CLI over the SSH connection, supporting the following commands:</p><ul>

  <li><p>The <code>forward-worker</code> command is used to reverse-tunnel a worker&#39;s addresses through the TSA and register the forwarded connections with the ATC. This allows workers running in arbitrary networks to register securely, so long as they can reach the TSA. This is much safer than opening the worker up to the outside world.</p></li>

  <li><p>The <code>land-worker</code> command is sent from the worker when landing, and initiates the state change to <a href="internals.html#LANDING-table"><code><strong>LANDING</strong></code></a> through the ATC.</p></li>

  <li><p>The <code>retire-worker</code> command is sent from the worker when retiring, and initiates the state change to <a href="internals.html#RETIRING-table"><code><strong>RETIRING</strong></code></a> through the ATC.</p></li>

  <li><p>The <code>delete-worker</code> command is sent from the worker when draining is interrupted while a worker is retiring. It removes the worker from the ATC.</p></li>

  <li><p>The <code>sweep-containers</code> command is sent periodically to facilitate garbage collection of containers which can be removed from the worker. It returns a list of handles for containers in the <code>DESTROYING</code> state, and it is the worker&#39;s job to subsequently destroy them.</p></li>

  <li><p>The <code>report-containers</code> command is sent along with the list of all container handles on the worker. The ATC uses this to update the database, removing any <code>DESTROYING</code> containers which are no longer in the set of handles, and marking any <code>CREATED</code> containers that are not present as missing.</p></li>

  <li><p>The <code>sweep-volumes</code> command is sent periodically to facilitate garbage collection of volumes which can be removed from the worker. It returns a list of handles for volumes in the <code>DESTROYING</code> state, and it is the worker&#39;s job to subsequently destroy them.</p></li>

  <li><p>The <code>report-volumes</code> command is sent along with the list of all volume handles on the worker. The ATC uses this to update the database, removing any <code>DESTROYING</code> volumes which are no longer in the set of handles, and marking any <code>CREATED</code> volumes that are not present as missing.</p></li>

</ul>

  
    
  
</div>
    
      <div class="section" id="section_architecture-worker">
  
  <h2 class="section-header"><a class="anchor-target" name="architecture-worker" href="#architecture-worker"></a>Workers: container runtime &amp; cache management</h2>
  

  <p>Workers are machines running <a href="https://github.com/cloudfoundry-incubator/garden">Garden</a> and <a href="https://github.com/concourse/baggageclaim">Baggageclaim</a> servers and registering themselves via the <a href="internals.html#component-tsa">TSA</a>.</p><p>Workers have no important state configured on their machines, as everything runs in a container and thus shouldn&#39;t care about what packages are installed on the host (well, except for those that allow it to be a worker in the first place). This is very different from workers in other non-containerized CI solutions, where the state of packages on the worker is crucial to whether your pipeline works or not.</p><p>Each worker registers itself with the Concourse cluster via the <a href="internals.html#component-tsa">TSA</a>.</p><p>Workers by default listen on port <code>7777</code> for Garden and port <code>7788</code> for Baggageclaim. If they are within a private network reachable by the <a href="internals.html#component-atc">ATC</a>, they&#39;ll probably bind on all addresses (<code>0.0.0.0</code>) and register themselves directly. Otherwise they should bind on <code>127.0.0.1</code> and forward themselves through the <a href="internals.html#component-tsa">TSA</a>.</p>

  
    
      <div class="section" id="section_worker-lifecycle">
  
  <h3 class="section-header"><a class="anchor-target" name="worker-lifecycle" href="#worker-lifecycle"></a>The worker lifecycle</h3>
  

  <div class="definition">
  <div class="definition-thumb">
    <a id="RUNNING-table"></a>
    <pre><a href="internals.html#RUNNING-table"><strong>RUNNING</strong></a></pre>
  </div>

  <div class="definition-content">
    <p>A worker in this state is registered with the cluster and ready to start running containers and storing volumes.</p>
  </div>
</div><div class="definition">
  <div class="definition-thumb">
    <a id="STALLED-table"></a>
    <pre><a href="internals.html#STALLED-table"><strong>STALLED</strong></a></pre>
  </div>

  <div class="definition-content">
    <p>A worker in this state was previously registered with the cluster, but stopped advertising itself for some reason. Ususally this is due to network connectivity issues, or the worker stopping unexpectedly.</p><p>If the worker remains in this state and cannot be recovered, it can be removed using the <a href="administration.html#fly-prune-worker"><code>fly prune-worker</code></a> command.</p>
  </div>
</div><div class="definition">
  <div class="definition-thumb">
    <a id="LANDING-table"></a>
    <pre><a href="internals.html#LANDING-table"><strong>LANDING</strong></a></pre>
  </div>

  <div class="definition-content">
    <p>The <code>concourse land-worker</code> command will put a worker in the LANDING state to safely drain its assignments for temporary downtime.</p><p>The ATC will wait for builds on the worker for jobs which aren&#39;t interruptible to finish, and transition the worker into <a href="internals.html#LANDED-table"><code><strong>LANDED</strong></code></a> state.</p>
  </div>
</div><div class="definition">
  <div class="definition-thumb">
    <a id="LANDED-table"></a>
    <pre><a href="internals.html#LANDED-table"><strong>LANDED</strong></a></pre>
  </div>

  <div class="definition-content">
    <p>A worker in this state has successfully waited for all non-interruptible jobs on it after having <code>concourse land-worker</code> called. It will no longer be used to schedule any new containers or create volumes until it registers as <a href="internals.html#RUNNING-table"><code><strong>RUNNING</strong></code></a> again.</p>
  </div>
</div><div class="definition">
  <div class="definition-thumb">
    <a id="RETIRING-table"></a>
    <pre><a href="internals.html#RETIRING-table"><strong>RETIRING</strong></a></pre>
  </div>

  <div class="definition-content">
    <p>The <code>concourse retire-worker</code> command will put a worker in the RETIRING state to remove it from the cluster permanently.</p><p>The ATC will wait for builds on the worker for jobs which aren&#39;t interruptible to finish, and remove the worker.</p>
  </div>
</div>

  
    
  
</div>
    
  
</div>
    
  
</div>

          <nav class="prev-next">
          
            <div class="prev">
              prev:

              
              <span class="section-number">1.13</span>
              

              <a href="observation.html">Observation</a>
            </div>
          

          
            <div class="next">
              next:

              
              <span class="section-number">2</span>
              

              <a href="examples.html">Examples</a>
            </div>
          
          </nav>
        </div>

        <div class="page-aside"></div>
      </div>
    </div>

    <ul class="improve-docs">
      <li><img src="images/icons/github-box.svg" /> <a href="https://github.com/concourse/docs">help improve this site</a></li>
      <li><img src="images/booklit.svg" /> powered by <a href="https://vito.github.io/booklit">Booklit</a></li>
    </ul>
  </body>
</html>