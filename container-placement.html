<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=775" />
<title>Container Placement - Concourse CI</title>
<link rel="stylesheet" type="text/css" href="css/normalize.css" />
<link rel="stylesheet" type="text/css" href="css/pipeline.css" />
<link rel="stylesheet" type="text/css" href="css/iosevka.css" />
<link rel="stylesheet" type="text/css" href="css/booklit.css" />
<link rel="stylesheet" type="text/css" href="css/prism.css" />
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
<link href="https://fonts.googleapis.com/css?family=Barlow:400,400i,700|Roboto+Slab:300,400,700" rel="stylesheet" />
<script src="js/search.js"></script>
<script async type="text/javascript" src="js/prism.js"></script>
<script data-goatcounter="https://concourse.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  </head>
  <body>
    <div class="top-banner">
  <p class="banner-text">
    <a href="https://github.com/orgs/concourse/discussions/9265">ðŸ“£ Call for Help: Check your database for us! ðŸ“£</a>
  </p>
</div>

<div class="page-top">
  <nav class="top-nav">
    <a class="top-link logo-link" href="/"><img src="images/logo-white.svg" />Concourse</a>
    
    <a class="top-link active" href="docs.html">Docs</a>
    
    <a class="top-link" href="examples.html">Examples</a>
    
    <a class="top-link" href="project.html">Project</a>
    
    <a class="top-link" href="ecosystem.html">Ecosystem</a>
    
    <a class="top-link" href="support.html">Support</a>
    
    <a class="top-link" href="https://resource-types.concourse-ci.org">Resource Types</a>
    <a class="top-link" href="https://blog.concourse-ci.org">blog</a>

    <div id="search"></div>

    <script type="text/javascript">
      var app = Elm.Search.init({
        node: document.getElementById('search')
      });

      app.ports.emitSearchTerm.subscribe(function(term) {
        goatcounter.count({
          path: "search:" + term,
          title: "user searched: " + term,
          event: true
        });
      });
    </script>
  </nav>
</div>

    <div class="page-body">
      <div class="page-nav">
        






  
  
  
  
  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1</span><a href="docs.html"  class="active">Docs</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.1</td>
            <td class="title-cell"><a href="getting-started.html" >Getting Started</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.2</td>
            <td class="title-cell"><a href="install.html" >Install</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.3</td>
            <td class="title-cell"><a href="auth.html" >Auth &amp; Teams</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.4</td>
            <td class="title-cell"><a href="fly.html" >The <code>fly</code> CLI</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.5</td>
            <td class="title-cell"><a href="config-basics.html" >Config Basics</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.6</td>
            <td class="title-cell"><a href="pipelines.html" >Pipelines</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.7</td>
            <td class="title-cell"><a href="vars.html" >Vars</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.8</td>
            <td class="title-cell"><a href="resources.html" >Resources</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.9</td>
            <td class="title-cell"><a href="resource-types.html" >Resource Types</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.10</td>
            <td class="title-cell"><a href="jobs.html" >Jobs</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.11</td>
            <td class="title-cell"><a href="steps.html" >Steps</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.12</td>
            <td class="title-cell"><a href="tasks.html" >Tasks</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.13</td>
            <td class="title-cell"><a href="builds.html" >Builds</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.14</td>
            <td class="title-cell"><a href="how-to-guides.html" >How-To Guides</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15</td>
            <td class="title-cell"><a href="operation.html"  class="active">Operation</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.16</td>
            <td class="title-cell"><a href="observation.html" >Observation</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.17</td>
            <td class="title-cell"><a href="internals.html" >Internals</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  

  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1.15</span><a href="operation.html"  class="active">Operation</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.15.1</td>
            <td class="title-cell"><a href="metrics.html" >Metrics</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.2</td>
            <td class="title-cell"><a href="tracing.html" >Tracing</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.3</td>
            <td class="title-cell"><a href="encryption.html" >Encryption</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.4</td>
            <td class="title-cell"><a href="creds.html" >Credential Management</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.5</td>
            <td class="title-cell"><a href="security-hardening.html" >Security Hardening</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.6</td>
            <td class="title-cell"><a href="container-placement.html"  class="self">Container Placement</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.7</td>
            <td class="title-cell"><a href="opa.html" >Open Policy Agent Integration</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.8</td>
            <td class="title-cell"><a href="performance-tuning.html" >Performance Tuning</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.9</td>
            <td class="title-cell"><a href="global-resources.html" >Global Resources</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.10</td>
            <td class="title-cell"><a href="administration.html" >Administration</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  

  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1.15.6</span><a href="container-placement.html"  class="self">Container Placement</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.15.6.1</td>
            <td class="title-cell"><a href="container-placement.html#volume-locality-strategy" >The <code>volume-locality</code> strategy</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.6.2</td>
            <td class="title-cell"><a href="container-placement.html#fewest-build-containers-strategy" >The <code>fewest-build-containers</code> strategy</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.6.3</td>
            <td class="title-cell"><a href="container-placement.html#random-strategy" >The <code>random</code> strategy</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.6.4</td>
            <td class="title-cell"><a href="container-placement.html#limit-active-tasks-strategy" >The <code>limit-active-tasks</code> strategy</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.6.5</td>
            <td class="title-cell"><a href="container-placement.html#limit-active-containers-strategy" >The <code>limit-active-containers</code> strategy</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.6.6</td>
            <td class="title-cell"><a href="container-placement.html#limit-active-volumes-strategy" >The <code>limit-active-volumes</code> strategy</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.6.7</td>
            <td class="title-cell"><a href="container-placement.html#chaining-placement-strategies" >Chaining Placement Strategies</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  



      </div>

      <div class="body-content">
        <div class="page-content">
          <div class="section" id="section_container-placement">
  
  <h1 class="section-header"><a class="anchor-target" name="container-placement" href="#container-placement"></a><span class="section-number">1.15.6 </span>Container Placement</h1>
  

  <p>Each <a href="steps.html">step</a> in a build is executed inside a container. The <a href="concourse-web.html"><code>web</code> node</a> distributes containers across the worker cluster depending on the configured strategy. If no workers satisfies the configured strategy, the <a href="steps.html">step</a> will block until a worker becomes available.</p>

  
    
      <div class="section" id="section_volume-locality-strategy">
  
  <h2 class="section-header"><a class="anchor-target" name="volume-locality-strategy" href="#volume-locality-strategy"></a>The <code>volume-locality</code> strategy</h2>
  

  <p>When using <code>volume-locality</code>, the <a href="concourse-web.html"><code>web</code> node</a> places <a href="task-step.html"><code>task</code> step</a> and <a href="put-step.html"><code>put</code> step</a> containers on workers where a majority of their inputs are already present. <strong>This is the default strategy.</strong></p><p>The advantage of this approach is that it reduces the likelihood that large artifacts will have to be streamed from one <a href="concourse-worker.html"><code>worker</code> node</a>, through the <a href="concourse-web.html"><code>web</code> node</a>, and to the target <a href="concourse-worker.html"><code>worker</code> node</a>. For large artifacts, this can result in quite a bit of overhead.</p><p>The disadvantage of this approach is that it can sometimes result in builds &#34;gravitating&#34; to a particular worker and overloading it, at least until the resource caches warm across the worker pool. This disadvantage can be partially mitigated using the (currently experimental) <a href="container-placement.html#limit-active-volumes-strategy"><code>limit-active-volumes</code> strategy</a> in conjunction with <a href="container-placement.html#chaining-placement-strategies">Chaining Placement Strategies</a>.</p><p>If your builds tend to be light on artifacts and heavy on task execution, you may want to try the <a href="container-placement.html#fewest-build-containers-strategy"><code>fewest-build-containers</code> strategy</a> or the (currently experimental) <a href="container-placement.html#limit-active-tasks-strategy"><code>limit-active-tasks</code> strategy</a>.</p>

  
    
  
</div>
    
      <div class="section" id="section_fewest-build-containers-strategy">
  
  <h2 class="section-header"><a class="anchor-target" name="fewest-build-containers-strategy" href="#fewest-build-containers-strategy"></a>The <code>fewest-build-containers</code> strategy</h2>
  

  <p>When using the <code>fewest-build-containers</code> strategy, step containers (<code>get</code>, <code>put</code>, <code>task</code>) are placed on the worker that has the fewest build containers (i.e. containers for other steps of other builds).</p><blockquote class="aside"><p>Containers used for resource checks are not counted because they are long-living containers that get re-used for multiple checks, and therefore consume very little resources on the worker.</p></blockquote><p>To use this strategy, set the following env var on the <a href="concourse-web.html"><code>web</code> node</a>:</p><pre><code class="language-bash">CONCOURSE_CONTAINER_PLACEMENT_STRATEGY=fewest-build-containers</code></pre>

  
    
  
</div>
    
      <div class="section" id="section_random-strategy">
  
  <h2 class="section-header"><a class="anchor-target" name="random-strategy" href="#random-strategy"></a>The <code>random</code> strategy</h2>
  

  <p>With the <code>random</code> strategy, the <a href="concourse-web.html"><code>web</code> node</a> places <code>get</code>, <code>put</code> and <code>task</code> containers on any worker, ignoring any affinity.</p><p>As this is truly random, this will be fine until one day it&#39;s not fine.</p><p>To use this strategy, set the following env var on the <a href="concourse-web.html"><code>web</code> node</a>:</p><pre><code class="language-bash">CONCOURSE_CONTAINER_PLACEMENT_STRATEGY=random</code></pre>

  
    
  
</div>
    
      <div class="section" id="section_limit-active-tasks-strategy">
  
  <h2 class="section-header"><a class="anchor-target" name="limit-active-tasks-strategy" href="#limit-active-tasks-strategy"></a>The <code>limit-active-tasks</code> strategy</h2>
  

  <p><div class="warning">
  <code>limit-active-tasks</code> is an <strong>experimental</strong> feature.
</div></p><p>When selecting the <code>limit-active-tasks</code> placement strategy, each <code>task</code> executed on a worker will increase the number of &#34;active tasks&#34; on that worker by one. When the task completes the number is decreased by one. The <a href="concourse-web.html"><code>web</code> node</a> then places <code>get</code>, <code>put</code> and <code>task</code> containers on the worker that currently has the <em>least amount of active tasks</em>.</p><p>Additionally <code>max-active-tasks-per-worker</code> can be set to an integer of 1 or more, in which case a worker will not execute more than that amount of <strong>tasks</strong>. A value of 0 means that there is no limit on the maximum number of active tasks on the workers. If no worker can be selected because all of them already have <code>max-active-tasks-per-worker</code> active tasks, then the task will wait for a free worker, periodically polling the pool. The metric <code>concourse_steps_waiting{type=&#34;task&#34;}</code> is emitted to monitor these events. Note that the parameter does not apply to <code>get</code> and <code>put</code> steps which will always be scheduled on the worker with the fewest active tasks.</p><p><pre><code class="language-bash">CONCOURSE_CONTAINER_PLACEMENT_STRATEGY=limit-active-tasks</code></pre> and, optionally <pre><code class="language-bash">CONCOURSE_MAX_ACTIVE_TASKS_PER_WORKER=1</code></pre></p>

  
    
  
</div>
    
      <div class="section" id="section_limit-active-containers-strategy">
  
  <h2 class="section-header"><a class="anchor-target" name="limit-active-containers-strategy" href="#limit-active-containers-strategy"></a>The <code>limit-active-containers</code> strategy</h2>
  

  <p><div class="warning">
  <code>limit-active-containers</code> is an <strong>experimental</strong> feature.
</div></p><p>The <code>limit-active-containers</code> placement strategy rejects workers that already have too many containers. It makes no effort to find the worker with the fewest number of containers present, and is therefore most useful when combined with other placement stragies by <a href="container-placement.html#chaining-placement-strategies">Chaining Placement Strategies</a>.</p><p><code>max-active-containers-per-worker</code> can be set to an integer of 1 or more, in which case a worker will not execute more than that amount of <strong>containers</strong>. If unset (or set to a value of 0), the <code>limit-active-containers</code> strategy has no effect - if this is your only placement strategy, workers will be chosen at random.</p><pre><code class="language-bash">CONCOURSE_CONTAINER_PLACEMENT_STRATEGY=limit-active-containers
CONCOURSE_MAX_ACTIVE_CONTAINERS_PER_WORKER=200</code></pre>

  
    
  
</div>
    
      <div class="section" id="section_limit-active-volumes-strategy">
  
  <h2 class="section-header"><a class="anchor-target" name="limit-active-volumes-strategy" href="#limit-active-volumes-strategy"></a>The <code>limit-active-volumes</code> strategy</h2>
  

  <p><div class="warning">
  <code>limit-active-volumes</code> is an <strong>experimental</strong> feature.
</div></p><p>The <code>limit-active-volumes</code> placement strategy rejects workers that already have too many volumes. It makes no effort to find the worker with the fewest number of volumes present, and is therefore most useful when combined with other placement stragies by <a href="container-placement.html#chaining-placement-strategies">Chaining Placement Strategies</a>.</p><p><code>max-active-volumes-per-worker</code> can be set to be an integer of 1 or more, in which case a worker will not execute more than that amount of <strong>volumes</strong>. If unset (or set to a value of 0), the <code>limit-active-volumes</code> strategy has no effect - if this is your only placement strategy, workers will be chosen at random.</p><pre><code class="language-bash">CONCOURSE_CONTAINER_PLACEMENT_STRATEGY=limit-active-volumes
CONCOURSE_MAX_ACTIVE_VOLUMES_PER_WORKER=200</code></pre>

  
    
  
</div>
    
      <div class="section" id="section_chaining-placement-strategies">
  
  <h2 class="section-header"><a class="anchor-target" name="chaining-placement-strategies" href="#chaining-placement-strategies"></a>Chaining Placement Strategies</h2>
  

  <p>Container placement strategies can be chained together to apply multiple strategies in sequence. The first strategy in the chain receives the entire set of workers, filtering the set down in some way, and passing that new set of workers to the next strategy in the chain. If the last strategy in the chain returns multiple workers, one will be chosen at random.</p><p>For instance, consider the following configuration:</p><pre><code class="language-bash">CONCOURSE_CONTAINER_PLACEMENT_STRATEGY=limit-active-containers,limit-active-volumes,volume-locality,fewest-build-containers
CONCOURSE_MAX_ACTIVE_CONTAINERS_PER_WORKER=200
CONCOURSE_MAX_ACTIVE_VOLUMES_PER_WORKER=100</code></pre><p>This defines a chain of 4 placement strategies, plus the implicit <code>random</code> strategy. Let&#39;s look at what each strategy accomplishes:</p><ol>

  <li><p><a href="container-placement.html#limit-active-containers-strategy"><code>limit-active-containers</code> strategy</a> removes all workers that already have more than 200 containers</p></li>

  <li><p><a href="container-placement.html#limit-active-volumes-strategy"><code>limit-active-volumes</code> strategy</a> removes all remaining workers that already have more than 100 volumes</p></li>

  <li><p><a href="container-placement.html#volume-locality-strategy"><code>volume-locality</code> strategy</a> keeps only the remaining worker(s) that have the most inputs locally. This can keep more than one worker in the case of a tie</p></li>

  <li><p><a href="container-placement.html#fewest-build-containers-strategy"><code>fewest-build-containers</code> strategy</a> will attempt to break ties by selecting the worker with fewer build containers. If all the remaining workers have the exact same number of containers, one will be selected at random.</p></li>

</ol>

  
    
  
</div>
    
  
</div>

          <nav class="prev-next">
          
            <div class="prev">
              prev:

              
              <span class="section-number">1.15.5</span>
              

              <a href="security-hardening.html">Security Hardening</a>
            </div>
          

          
            <div class="next">
              next:

              
              <span class="section-number">1.15.7</span>
              

              <a href="opa.html">Open Policy Agent Integration</a>
            </div>
          
          </nav>
        </div>

        <div class="page-aside"></div>
      </div>
    </div>

    <ul class="improve-docs">
      <li><img src="images/icons/github-box.svg" /> <a href="https://github.com/concourse/docs">help improve this site</a></li>
      <li><img src="images/booklit.svg" /> powered by <a href="https://vito.github.io/booklit">Booklit</a></li>
    </ul>
  </body>
</html>