<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=775" />
<title>Running a web node - Concourse CI</title>
<link rel="stylesheet" type="text/css" href="css/normalize.css" />
<link rel="stylesheet" type="text/css" href="css/pipeline.css" />
<link rel="stylesheet" type="text/css" href="css/iosevka.css" />
<link rel="stylesheet" type="text/css" href="css/booklit.css" />
<link rel="stylesheet" type="text/css" href="css/prism.css" />
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
<link href="https://fonts.googleapis.com/css?family=Barlow:400,400i,700|Roboto+Slab:300,400,700" rel="stylesheet" />
<script src="js/search.js"></script>
<script async type="text/javascript" src="js/prism.js"></script>
<script data-goatcounter="https://concourse.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  </head>
  <body>
    

<div class="page-top">
  <nav class="top-nav">
    <a class="top-link logo-link" href="/"><img src="images/logo-white.svg" />Concourse</a>
    
    <a class="top-link active" href="docs.html">Docs</a>
    
    <a class="top-link" href="examples.html">Examples</a>
    
    <a class="top-link" href="project.html">Project</a>
    
    <a class="top-link" href="ecosystem.html">Ecosystem</a>
    
    <a class="top-link" href="https://resource-types.concourse-ci.org">Resource Types</a>
    <a class="top-link" href="https://blog.concourse-ci.org">blog</a>
    <a class="top-link" href="https://github.com/concourse/concourse/discussions">discuss</a>

    <div id="search"></div>

    <script type="text/javascript">
      var app = Elm.Main.init({
        node: document.getElementById('search')
      });

      app.ports.emitSearchTerm.subscribe(function(term) {
        goatcounter.count({
          path: "search:" + term,
          title: "user searched: " + term,
          event: true
        });
      });
    </script>
  </nav>
</div>

    <div class="page-body">
      <div class="page-nav">
        






  
  
  
  
  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1</span><a href="docs.html"  class="active">Docs</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.1</td>
            <td class="title-cell"><a href="getting-started.html" >Getting Started</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.2</td>
            <td class="title-cell"><a href="install.html"  class="active">Install</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.3</td>
            <td class="title-cell"><a href="auth.html" >Auth &amp; Teams</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.4</td>
            <td class="title-cell"><a href="fly.html" >The <code>fly</code> CLI</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.5</td>
            <td class="title-cell"><a href="config-basics.html" >Config Basics</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.6</td>
            <td class="title-cell"><a href="pipelines.html" >Pipelines</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.7</td>
            <td class="title-cell"><a href="vars.html" >Vars</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.8</td>
            <td class="title-cell"><a href="resources.html" >Resources</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.9</td>
            <td class="title-cell"><a href="resource-types.html" >Resource Types</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.10</td>
            <td class="title-cell"><a href="jobs.html" >Jobs</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.11</td>
            <td class="title-cell"><a href="steps.html" >Steps</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.12</td>
            <td class="title-cell"><a href="tasks.html" >Tasks</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.13</td>
            <td class="title-cell"><a href="builds.html" >Builds</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.14</td>
            <td class="title-cell"><a href="how-to-guides.html" >How-To Guides</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15</td>
            <td class="title-cell"><a href="operation.html" >Operation</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.16</td>
            <td class="title-cell"><a href="observation.html" >Observation</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.17</td>
            <td class="title-cell"><a href="internals.html" >Internals</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  

  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1.2</span><a href="install.html"  class="active">Install</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.2.1</td>
            <td class="title-cell"><a href="postgresql-node.html" >Running a PostgreSQL node</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.2.2</td>
            <td class="title-cell"><a href="concourse-cli.html" >The <code>concourse</code> CLI</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.2.3</td>
            <td class="title-cell"><a href="concourse-generate-key.html" >Generating Keys</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.2.4</td>
            <td class="title-cell"><a href="concourse-web.html"  class="self">Running a <code>web</code> node</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.2.5</td>
            <td class="title-cell"><a href="concourse-worker.html" >Running a <code>worker</code> node</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.2.6</td>
            <td class="title-cell"><a href="upgrading-concourse.html" >Upgrading Concourse</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  

  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1.2.4</span><a href="concourse-web.html"  class="self">Running a <code>web</code> node</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.2.4.1</td>
            <td class="title-cell"><a href="concourse-web.html#web-prerequisites" >Prerequisites</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.2.4.2</td>
            <td class="title-cell"><a href="concourse-web.html#web-running" >Running <code>concourse web</code></a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.2.4.3</td>
            <td class="title-cell"><a href="concourse-web.html#web-operation" >Operating a <code>web</code> node</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.2.4.4</td>
            <td class="title-cell"><a href="concourse-web.html#web-configuration" >Configuring the <code>web</code> node</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  



      </div>

      <div class="body-content">
        <div class="page-content">
          <div class="section" id="section_concourse-web">
  
  <h1 class="section-header"><a class="anchor-target" name="concourse-web" href="#concourse-web"></a><span class="section-number">1.2.4 </span>Running a <code>web</code> node</h1>
  

  <p>The <code>web</code> node is responsible for running the web UI, API, and as well as performing all pipeline scheduling. It&#39;s basically the brain of Concourse.</p><div class="table-of-contents">
  <span class="toc-header">Table of contents:</span>

  
  
  <ol class="toc">
  
    <li>
      <span class="section-number">1.2.4.1</span>
      <a href="concourse-web.html#web-prerequisites">Prerequisites</a>

      
  
  
    </li>
  
    <li>
      <span class="section-number">1.2.4.2</span>
      <a href="concourse-web.html#web-running">Running <code>concourse web</code></a>

      
  
  <ol class="toc">
  
    <li>
      <span class="section-number">1.2.4.2.1</span>
      <a href="concourse-web.html#web-resource-utilization">Resource utilization</a>

      
  
  
    </li>
  
  </ol>
  
  
    </li>
  
    <li>
      <span class="section-number">1.2.4.3</span>
      <a href="concourse-web.html#web-operation">Operating a <code>web</code> node</a>

      
  
  <ol class="toc">
  
    <li>
      <span class="section-number">1.2.4.3.1</span>
      <a href="concourse-web.html#scaling">Scaling</a>

      
  
  <ol class="toc">
  
    <li>
      <span class="section-number">1.2.4.3.1.1</span>
      <a href="concourse-web.html#web-connection-pooling">Database connection pooling</a>

      
  
  
    </li>
  
  </ol>
  
  
    </li>
  
    <li>
      <span class="section-number">1.2.4.3.2</span>
      <a href="concourse-web.html#reloading-worker-authorized-key">Reloading worker authorized key</a>

      
  
  
    </li>
  
    <li>
      <span class="section-number">1.2.4.3.3</span>
      <a href="concourse-web.html#restarting-and-upgrading">Restarting &amp; Upgrading</a>

      
  
  
    </li>
  
    <li>
      <span class="section-number">1.2.4.3.4</span>
      <a href="concourse-web.html#downgrading">Downgrading</a>

      
  
  
    </li>
  
  </ol>
  
  
    </li>
  
    <li>
      <span class="section-number">1.2.4.4</span>
      <a href="concourse-web.html#web-configuration">Configuring the <code>web</code> node</a>

      
  
  <ol class="toc">
  
    <li>
      <span class="section-number">1.2.4.4.1</span>
      <a href="concourse-web.html#giving-your-cluster-a-name">Giving your cluster a name</a>

      
  
  
    </li>
  
    <li>
      <span class="section-number">1.2.4.4.2</span>
      <a href="concourse-web.html#web-ingress">Configuring ingress traffic</a>

      
  
  
    </li>
  
    <li>
      <span class="section-number">1.2.4.4.3</span>
      <a href="concourse-web.html#lets-encrypt">TLS via Let&#39;s Encrypt</a>

      
  
  
    </li>
  
    <li>
      <span class="section-number">1.2.4.4.4</span>
      <a href="concourse-web.html#build-log-retention">Build log retention</a>

      
  
  
    </li>
  
    <li>
      <span class="section-number">1.2.4.4.5</span>
      <a href="concourse-web.html#audit-logs">Enabling audit logs</a>

      
  
  
    </li>
  
    <li>
      <span class="section-number">1.2.4.4.6</span>
      <a href="concourse-web.html#resource-defaults">Configuring defaults for resource types</a>

      
  
  
    </li>
  
  </ol>
  
  
    </li>
  
  </ol>
  
  
</div>

  
    
      <div class="section" id="section_web-prerequisites">
  
  <h2 class="section-header"><a class="anchor-target" name="web-prerequisites" href="#web-prerequisites"></a>Prerequisites</h2>
  

  <p>Nothing special - the <code>web</code> node is a pretty simple Go application that can be run like a <a href="https://en.wikipedia.org/wiki/Twelve-Factor_App_methodology">12-factor app</a>.</p>

  
    
  
</div>
    
      <div class="section" id="section_web-running">
  
  <h2 class="section-header"><a class="anchor-target" name="web-running" href="#web-running"></a>Running <code>concourse web</code></h2>
  

  <p>The <code>concourse</code> CLI can run as a <code>web</code> node via the <code>web</code> subcommand.</p><p>Before running it, let&#39;s configure a local user so we can log in:</p><pre><code class="language-bash">CONCOURSE_ADD_LOCAL_USER=myuser:mypass
CONCOURSE_MAIN_TEAM_LOCAL_USER=myuser</code></pre><p>This will configure a single user, <code>myuser</code>, with the password <code>mypass</code>. You&#39;ll probably want to change those to sensible values, and later you may want to configure a proper auth provider - check out <a href="auth.html">Auth &amp; Teams</a> whenever you&#39;re ready.</p><p>Next, you&#39;ll need to configure the session signing key, the SSH key for the worker gateway, and the authorized worker key. Check <a href="concourse-generate-key.html">Generating Keys</a> to learn what these are and how they are created.</p><pre><code class="language-bash">CONCOURSE_SESSION_SIGNING_KEY=path/to/session_signing_key
CONCOURSE_TSA_HOST_KEY=path/to/tsa_host_key
CONCOURSE_TSA_AUTHORIZED_KEYS=path/to/authorized_worker_keys.pub</code></pre><p>Finally, <code>web</code> needs to know how to reach your Postgres database. This can be set like so:</p><pre><code class="language-bash">CONCOURSE_POSTGRES_HOST=127.0.0.1 # default
CONCOURSE_POSTGRES_PORT=5432      # default
CONCOURSE_POSTGRES_DATABASE=atc   # default
CONCOURSE_POSTGRES_USER=my-user
CONCOURSE_POSTGRES_PASSWORD=my-password</code></pre><p>If you&#39;re running PostgreSQL locally, you can probably just point it to the socket and rely on the <code>peer</code> auth:</p><pre><code class="language-bash">CONCOURSE_POSTGRES_SOCKET=/var/run/postgresql</code></pre><p>Now that everything&#39;s set, run:</p><pre><code class="language-bash">concourse web</code></pre><p>All logs will be emitted to <code>stdout</code>, with any panics or lower-level errors being emitted to <code>stderr</code>.</p>

  
    
      <div class="section" id="section_web-resource-utilization">
  
  <h3 class="section-header"><a class="anchor-target" name="web-resource-utilization" href="#web-resource-utilization"></a>Resource utilization</h3>
  

  <p>CPU usage: peaks during pipeline scheduling, primarily when scheduling <a href="jobs.html">Jobs</a>. Mitigated by adding more <code>web</code> nodes. In this regard, <code>web</code> nodes can be considered compute-heavy more than anything else at large scale.</p><p>Memory usage: not very well classified at the moment as it&#39;s not generally a concern. Give it a few gigabytes and keep an eye on it.</p><p>Disk usage: none</p><p>Bandwidth usage: aside from handling external traffic, the <code>web</code> node will at times have to stream bits out from one worker and into another while executing <a href="steps.html">Steps</a>.</p><p>Highly available: yes; <code>web</code> nodes can all be configured the same (aside from <code>--peer-address</code>) and placed behind a load balancer. Periodic tasks like garbage-collection will not be duplicated for each node.</p><p>Horizontally scalable: yes; they will coordinate workloads using the database, resulting in less work for each node and thus lower CPU usage.</p><p>Outbound traffic:</p><ul>

  <li><p><code>db</code> on its configured port for persistence</p></li>

  <li><p><code>db</code> on its configured port for locking and coordinating in a multi-<code>web</code> node deployment</p></li>

  <li><p>other <code>web</code> nodes (possibly itself) on an <a href="https://en.wikipedia.org/wiki/Ephemeral_port">ephemeral port</a> when a worker is forwarded through the web node&#39;s TSA</p></li>

</ul><p>Inbound traffic:</p><ul>

  <li><p><code>worker</code> connects to the TSA on port <code>2222</code> for registration</p></li>

  <li><p><code>worker</code> downloads inputs from the ATC during <a href="tasks.html#running-tasks"><code>fly execute</code></a> via its external URL</p></li>

  <li><p>external traffic to the ATC API via the web UI and <a href="fly.html"><code>fly</code> CLI</a></p></li>

</ul>

  
    
  
</div>
    
  
</div>
    
      <div class="section" id="section_web-operation">
  
  <h2 class="section-header"><a class="anchor-target" name="web-operation" href="#web-operation"></a>Operating a <code>web</code> node</h2>
  

  <p>The <code>web</code> nodes themselves are stateless - they don&#39;t store anything on disk, and coordinate entirely using the database.</p>

  
    
      <div class="section" id="section_scaling">
  
  <h3 class="section-header"><a class="anchor-target" name="scaling" href="#scaling"></a>Scaling</h3>
  

  <p>The <a href="concourse-web.html"><code>web</code> node</a> can be scaled up for high availability. They&#39;ll also roughly share their scheduling workloads, using the database to synchronize. This is done by just running more <code>web</code> commands on different machines, and optionally putting them behind a load balancer.</p><p>To run a cluster of <a href="concourse-web.html"><code>web</code> node</a>s, you&#39;ll first need to ensure they&#39;re all pointing to the same PostgreSQL server.</p><p>Next, you&#39;ll need to configure a <em>peer address</em>. This is a DNS or IP address that can be used to reach this <code>web</code> node from other <code>web</code> nodes. Typically this uses a private IP, like so:</p><pre><code class="language-bash">CONCOURSE_PEER_ADDRESS=10.10.0.1</code></pre><p>This address will be used for forwarded worker connections, which listen on the <a href="https://en.wikipedia.org/wiki/Ephemeral_port">ephemeral port</a> range.</p><p>Finally, if all of these nodes are going to be accessed through a load balancer, you&#39;ll need to configure the external URL that will be used to reach your Concourse cluster:</p><pre><code class="language-bash">CONCOURSE_EXTERNAL_URL=https://ci.example.com</code></pre><p>Aside from the peer URL, all configuration must be consistent across all <code>web</code> nodes in the cluster to ensure consistent results.</p>

  
    
      <div class="section" id="section_web-connection-pooling">
  
  <h4 class="section-header"><a class="anchor-target" name="web-connection-pooling" href="#web-connection-pooling"></a>Database connection pooling</h4>
  

  <p>You may wish to configure the max number of parallel database connections that each node makes. There are two pools to configure: one for serving API requests, and one used for all the backend work such as pipeline scheduling.</p><pre><code class="language-bash">CONCOURSE_API_MAX_CONNS=10     # default
CONCOURSE_BACKEND_MAX_CONNS=50 # default</code></pre><p>There are some non-configurable connection pools. They take up the following number of connections per pool: <ul>

  <li><p>Garbage Collection: 5</p></li>

  <li><p>Lock: 1</p></li>

  <li><p>Worker Registration: 1</p></li>

</ul></p><p>The sum of these numbers across all <code>web</code> nodes should not be greater than the maximum number of simultaneous connections your Postgres server will allow. See <a href="postgresql-node.html#db-resource-utilization"><code>db</code> node resource utilization</a> for more information.</p><p>For example, if 3 <code>web</code> nodes are configured with the values shown above then your PostgreSQL server should be configured with a connection limit of at least 201: <code>(10 &#43; 50 &#43; 5 &#43; 1 &#43; 1) * 3 web nodes</code>.</p>

  
    
  
</div>
    
  
</div>
    
      <div class="section" id="section_reloading-worker-authorized-key">
  
  <h3 class="section-header"><a class="anchor-target" name="reloading-worker-authorized-key" href="#reloading-worker-authorized-key"></a>Reloading worker authorized key</h3>
  

  <p>While <a href="concourse-web.html#web-running">Running <code>concourse web</code></a>, the authorized worker key file, which contains all public keys for the workers, is loaded at startup. During the lifecycle of a <a href="concourse-web.html"><code>web</code> node</a> new <code>worker</code> keys might be added or old ones removed. To perform a live reload of this file you can send a <code>SIGHUP</code> signal to the <code>concourse web</code> process. The process will remain running and Concourse will reload the authorized worker key file.</p>

  
    
  
</div>
    
      <div class="section" id="section_restarting-and-upgrading">
  
  <h3 class="section-header"><a class="anchor-target" name="restarting-and-upgrading" href="#restarting-and-upgrading"></a>Restarting &amp; Upgrading</h3>
  

  <p>The <code>web</code> nodes can be killed and restarted willy-nilly. No draining is necessary; if the <code>web</code> node was orchestrating a build it will continue where it left off when it comes back, or the build will be picked up by one of the other <code>web</code> nodes.</p><p>To upgrade a <code>web</code> node, stop its process and start a new one using the newly installed <code>concourse</code>. Any database migrations will be run automatically on start. If <code>web</code> nodes are started in parallel, only one will run the migrations.</p><p>We don&#39;t currently guarantee a lack of funny-business if you&#39;re running mixed Concourse versions - database migrations can perform modifications that confuse other <code>web</code> nodes. So there may be some turbulence during a rolling upgrade, but everything should stabilize once all <code>web</code> nodes are running the latest version.</p><p>If you want more control over when the database migrations happen and know if they were successful you can use the <code>concourse migrate</code> command. The <code>migrate</code> command accepts the same <code>CONCOURSE_POSTGRES_*</code> env vars as the <code>concourse web</code> command.</p>

  
    
  
</div>
    
      <div class="section" id="section_downgrading">
  
  <h3 class="section-header"><a class="anchor-target" name="downgrading" href="#downgrading"></a>Downgrading</h3>
  

  <p>If you&#39;re stuck in a pinch and need to downgrade from one version of Concourse to another, you can use the <code>concourse migrate</code> command.</p><p>First, grab the desired migration version by running the following:</p><pre><code class="language-bash"># make sure this is the *old* Concourse binary
$ concourse migrate --supported-db-version
1551110547</code></pre><p>That number (yours will be different) is the expected migration version for that version of Concourse.</p><p>Next, run the following with the <em>new</em> Concourse binary:</p><pre><code class="language-bash">$ concourse migrate --migrate-db-to-version=1551110547</code></pre><p>This will need the same <code>CONCOURSE_POSTGRES_*</code> configuration described in <a href="concourse-web.html#web-running">Running <code>concourse web</code></a>.</p><p>Once this completes, switch all <code>web</code> nodes back to the older <code>concourse</code> binary and you should be good to go.</p>

  
    
  
</div>
    
  
</div>
    
      <div class="section" id="section_web-configuration">
  
  <h2 class="section-header"><a class="anchor-target" name="web-configuration" href="#web-configuration"></a>Configuring the <code>web</code> node</h2>
  

  

  
    
      <div class="section" id="section_giving-your-cluster-a-name">
  
  <h3 class="section-header"><a class="anchor-target" name="giving-your-cluster-a-name" href="#giving-your-cluster-a-name"></a>Giving your cluster a name</h3>
  

  <p>If you&#39;ve got many Concourse clusters that you switch between, you can make it slightly easier to notice which one you&#39;re on by giving each cluster a name:</p><pre><code class="language-bash">CONCOURSE_CLUSTER_NAME=production</code></pre><p>When set, this name will be shown in the top bar when viewing the dashboard.</p>

  
    
  
</div>
    
      <div class="section" id="section_web-ingress">
  
  <h3 class="section-header"><a class="anchor-target" name="web-ingress" href="#web-ingress"></a>Configuring ingress traffic</h3>
  

  <p>If your web nodes are going to be accessed multiple network layers, you will need to set <code>CONCOURSE_EXTERNAL_URL</code> to a URL accessible by your Concourse users. If you don&#39;t set this property, logging in will incorrectly redirect to its default value of <code>127.0.0.1</code>.</p><p>If your web node(s) will be behind a load balancer or reverse proxy then you will need to ensure connctions made by <a href="builds.html#fly-intercept"><code>fly intercept</code></a> are properly handled by upgrading the connection. Here is a sample nginx configuration that upgrades connections made by <a href="builds.html#fly-intercept"><code>fly intercept</code></a>.</p><pre><code class="language-">server {
  server_name ci.example.com;

  add_header Strict-Transport-Security &#34;max-age=31536000&#34; always;
  ssl_stapling on;
  ssl_stapling_verify on;

  # Proxy main concourse traffic
  location / {
      proxy_pass http://concourse.local:8080/;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Protocol $scheme;
      proxy_set_header X-Forwarded-Host $http_host;
  }

  # Proxy fly intercept traffic
  location ~ /hijack$ {
      proxy_pass http://concourse.local:8080;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Protocol $scheme;
      proxy_set_header X-Forwarded-Host $http_host;
      # Upgrade connection
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection &#34;upgrade&#34;;
  }
}</code></pre>

  
    
  
</div>
    
      <div class="section" id="section_lets-encrypt">
  
  <h3 class="section-header"><a class="anchor-target" name="lets-encrypt" href="#lets-encrypt"></a>TLS via Let&#39;s Encrypt</h3>
  

  <p>Concourse can be configured to automatically acquire a TLS certificate via <a href="https://letsencrypt.org">Let&#39;s Encrypt</a>:</p><pre><code class="language-bash"># Enable TLS
CONCOURSE_TLS_BIND_PORT=443

# Enable Let&#39;s Encrypt
CONCOURSE_ENABLE_LETS_ENCRYPT=true</code></pre><div class="warning">
  <p>Concourse&#39;s Let&#39;s Encrypt integration works by storing the TLS certificate and key in the database, so it is imperative that you enable <a href="encryption.html">database encryption</a> as well.</p>
</div><p>By default, Concourse will reach out to <a href="https://acme-v02.api.letsencrypt.org/directory">Let&#39;s Encrypt&#39;s ACME CA directory</a>. An alernative URL can be configured like so:</p><pre><code class="language-bash">CONCOURSE_LETS_ENCRYPT_ACME_URL=https://acme.example.com/directory</code></pre><p>In order to negotiate the certificate, your <code>web</code> node must be reachable by the ACME server. There are intentionally <a href="https://letsencrypt.org/docs/faq/">no publicly listed IP addresses to whitelist</a>, so this typically means just making your <code>web</code> node publicly reachable.</p>

  
    
  
</div>
    
      <div class="section" id="section_build-log-retention">
  
  <h3 class="section-header"><a class="anchor-target" name="build-log-retention" href="#build-log-retention"></a>Build log retention</h3>
  

  <p>Build logs are stored in the DB - if they are not cleanup up every once in a while, the storage usage for build logs will continue to grow as more builds run. While this is usually fine for small Concourse instances, as you scale up, you may run into storage concerns.</p><p>To clean up old build logs, you can configure Concourse to periodically scan for builds whose logs should be reaped based on a log retention policy, skipping over any paused pipelines and jobs. When a build&#39;s logs are reaped, they are no longer visible in the UI.</p><p>Concourse can be configured with a default build log retention policy for all jobs:</p><pre><code class="language-bash">CONCOURSE_DEFAULT_BUILD_LOGS_TO_RETAIN=50
CONCOURSE_DEFAULT_DAYS_TO_RETAIN_BUILD_LOGS=14</code></pre><p>With these settings, Concource will keep the latest 50 builds for each job. If a job runs more than 50 builds in 14 days, all of those builds will be retained until 14 days after they ran.</p><p>Some jobs have differing retention requirements - you can configure <a href="jobs.html#schema.build_log_retention_policy"><strong><code>build_log_retention_policy</code></strong> schema</a> on a job-by-job basis.</p><p>You can also configure Concourse with maximum values for build log retention policies to prevent jobs from retaining their build logs for too long:</p><pre><code class="language-bash">CONCOURSE_MAX_BUILD_LOGS_TO_RETAIN=100
CONCOURSE_MAX_DAYS_TO_RETAIN_BUILD_LOGS=30</code></pre><p>With these settings, <a href="jobs.html#schema.build_log_retention_policy.builds"><code class="schema-attribute-name"><bold>build_log_retention_policy<wbr />.builds</bold></code></a> is capped at 100, and <a href="jobs.html#schema.build_log_retention_policy.days"><code class="schema-attribute-name"><bold>build_log_retention_policy<wbr />.days</bold></code></a> is capped at 30.</p>

  
    
  
</div>
    
      <div class="section" id="section_audit-logs">
  
  <h3 class="section-header"><a class="anchor-target" name="audit-logs" href="#audit-logs"></a>Enabling audit logs</h3>
  

  <p>A very simplistic form of audit logging can be enabled with the following vars:</p><pre><code class="language-bash"># Enable auditing for all api requests connected to builds.
CONCOURSE_ENABLE_BUILD_AUDITING=true

# Enable auditing for all api requests connected to containers.
CONCOURSE_ENABLE_CONTAINER_AUDITING=true

# Enable auditing for all api requests connected to jobs.
CONCOURSE_ENABLE_JOB_AUDITING=true

# Enable auditing for all api requests connected to pipelines.
CONCOURSE_ENABLE_PIPELINE_AUDITING=true

# Enable auditing for all api requests connected to resources.
CONCOURSE_ENABLE_RESOURCE_AUDITING=true

# Enable auditing for all api requests connected to system transactions.
CONCOURSE_ENABLE_SYSTEM_AUDITING=true

# Enable auditing for all api requests connected to teams.
CONCOURSE_ENABLE_TEAM_AUDITING=true

# Enable auditing for all api requests connected to workers.
CONCOURSE_ENABLE_WORKER_AUDITING=true

# Enable auditing for all api requests connected to volumes.
CONCOURSE_ENABLE_VOLUME_AUDITING=true</code></pre><p>When enabled, API requests will result in an info-level log line like so:</p><pre><code class="language-json">{&#34;timestamp&#34;:&#34;2019-05-09T14:41:54.880381537Z&#34;,&#34;level&#34;:&#34;info&#34;,&#34;source&#34;:&#34;atc&#34;,&#34;message&#34;:&#34;atc.audit&#34;,&#34;data&#34;:{&#34;action&#34;:&#34;Info&#34;,&#34;parameters&#34;:{},&#34;user&#34;:&#34;test&#34;}}
{&#34;timestamp&#34;:&#34;2019-05-09T14:42:36.704864093Z&#34;,&#34;level&#34;:&#34;info&#34;,&#34;source&#34;:&#34;atc&#34;,&#34;message&#34;:&#34;atc.audit&#34;,&#34;data&#34;:{&#34;action&#34;:&#34;GetPipeline&#34;,&#34;parameters&#34;:{&#34;:pipeline_name&#34;:[&#34;booklit&#34;],&#34;:team_name&#34;:[&#34;main&#34;]},&#34;user&#34;:&#34;test&#34;}}</code></pre>

  
    
  
</div>
    
      <div class="section" id="section_resource-defaults">
  
  <h3 class="section-header"><a class="anchor-target" name="resource-defaults" href="#resource-defaults"></a>Configuring defaults for resource types</h3>
  

  <p>Defaults for the &#34;core&#34; resource types (<a href="https://github.com/concourse?q=-resource">those that show up under the Concourse org</a>) that comes with Concourse can be set cluster-wide by passing in a configuration file. The format of the file is the name of the resource type followed by an arbitrary configuration.</p><p>Documentation for each resource type&#39;s configuration is in each implementation&#39;s <code>README</code>.</p><pre><code class="language-bash">CONCOURSE_BASE_RESOURCE_TYPE_DEFAULTS=./defaults.yml</code></pre><p>For example, a <code>defaults.yml</code> that configures the entire cluster to use a registry mirror would have: <pre><code class="language-yaml">registry-image:
  registry_mirror:
    host: https://registry.mirror.example.com</code></pre></p>

  
    
  
</div>
    
  
</div>
    
  
</div>

          <nav class="prev-next">
          
            <div class="prev">
              prev:

              
              <span class="section-number">1.2.3</span>
              

              <a href="concourse-generate-key.html">Generating Keys</a>
            </div>
          

          
            <div class="next">
              next:

              
              <span class="section-number">1.2.5</span>
              

              <a href="concourse-worker.html">Running a <code>worker</code> node</a>
            </div>
          
          </nav>
        </div>

        <div class="page-aside"></div>
      </div>
    </div>

    <ul class="improve-docs">
      <li><img src="images/icons/github-box.svg" /> <a href="https://github.com/concourse/docs">help improve this site</a></li>
      <li><img src="images/booklit.svg" /> powered by <a href="https://vito.github.io/booklit">Booklit</a></li>
    </ul>
  </body>
</html>