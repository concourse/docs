<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=775" />
<title>The Vault credential manager - Concourse CI</title>
<link rel="stylesheet" type="text/css" href="css/normalize.css" />
<link rel="stylesheet" type="text/css" href="css/pipeline.css" />
<link rel="stylesheet" type="text/css" href="css/iosevka.css" />
<link rel="stylesheet" type="text/css" href="css/booklit.css" />
<link rel="stylesheet" type="text/css" href="css/prism.css" />
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
<link href="https://fonts.googleapis.com/css?family=Barlow:400,400i,700|Roboto+Slab:300,400,700" rel="stylesheet" />
<script src="js/search.js"></script>
<script async type="text/javascript" src="js/prism.js"></script>
<script data-goatcounter="https://concourse.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  </head>
  <body>
    

<div class="page-top">
  <nav class="top-nav">
    <a class="top-link logo-link" href="/"><img src="images/logo-white.svg" />Concourse</a>
    
    <a class="top-link active" href="docs.html">Docs</a>
    
    <a class="top-link" href="examples.html">Examples</a>
    
    <a class="top-link" href="project.html">Project</a>
    
    <a class="top-link" href="ecosystem.html">Ecosystem</a>
    
    <a class="top-link" href="https://resource-types.concourse-ci.org">Resource Types</a>
    <a class="top-link" href="https://blog.concourse-ci.org">blog</a>
    <a class="top-link" href="https://github.com/concourse/concourse/discussions">discuss</a>

    <div id="search"></div>

    <script type="text/javascript">
      var app = Elm.Main.init({
        node: document.getElementById('search')
      });

      app.ports.emitSearchTerm.subscribe(function(term) {
        goatcounter.count({
          path: "search:" + term,
          title: "user searched: " + term,
          event: true
        });
      });
    </script>
  </nav>
</div>

    <div class="page-body">
      <div class="page-nav">
        






  
  
  
  
  
  
  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1</span><a href="docs.html"  class="active">Docs</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.1</td>
            <td class="title-cell"><a href="getting-started.html" >Getting Started</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.2</td>
            <td class="title-cell"><a href="install.html" >Install</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.3</td>
            <td class="title-cell"><a href="auth.html" >Auth &amp; Teams</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.4</td>
            <td class="title-cell"><a href="fly.html" >The <code>fly</code> CLI</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.5</td>
            <td class="title-cell"><a href="config-basics.html" >Config Basics</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.6</td>
            <td class="title-cell"><a href="pipelines.html" >Pipelines</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.7</td>
            <td class="title-cell"><a href="vars.html" >Vars</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.8</td>
            <td class="title-cell"><a href="resources.html" >Resources</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.9</td>
            <td class="title-cell"><a href="resource-types.html" >Resource Types</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.10</td>
            <td class="title-cell"><a href="jobs.html" >Jobs</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.11</td>
            <td class="title-cell"><a href="steps.html" >Steps</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.12</td>
            <td class="title-cell"><a href="tasks.html" >Tasks</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.13</td>
            <td class="title-cell"><a href="builds.html" >Builds</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.14</td>
            <td class="title-cell"><a href="how-to-guides.html" >How-To Guides</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15</td>
            <td class="title-cell"><a href="operation.html"  class="active">Operation</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.16</td>
            <td class="title-cell"><a href="observation.html" >Observation</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.17</td>
            <td class="title-cell"><a href="internals.html" >Internals</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  

  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1.15</span><a href="operation.html"  class="active">Operation</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.15.1</td>
            <td class="title-cell"><a href="metrics.html" >Metrics</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.2</td>
            <td class="title-cell"><a href="tracing.html" >Tracing</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.3</td>
            <td class="title-cell"><a href="encryption.html" >Encryption</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.4</td>
            <td class="title-cell"><a href="creds.html"  class="active">Credential Management</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.5</td>
            <td class="title-cell"><a href="container-placement.html" >Container Placement</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.6</td>
            <td class="title-cell"><a href="opa.html" >Open Policy Agent Integration</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.7</td>
            <td class="title-cell"><a href="performance-tuning.html" >Performance Tuning</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.8</td>
            <td class="title-cell"><a href="global-resources.html" >Global Resources</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.9</td>
            <td class="title-cell"><a href="administration.html" >Administration</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  

  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1.15.4</span><a href="creds.html"  class="active">Credential Management</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.15.4.1</td>
            <td class="title-cell"><a href="vault-credential-manager.html"  class="self">The Vault credential manager</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.4.2</td>
            <td class="title-cell"><a href="credhub-credential-manager.html" >The CredHub credential manager</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.4.3</td>
            <td class="title-cell"><a href="aws-ssm-credential-manager.html" >The AWS SSM credential manager</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.4.4</td>
            <td class="title-cell"><a href="aws-asm-credential-manager.html" >The AWS Secrets Manager credential manager</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.4.5</td>
            <td class="title-cell"><a href="kubernetes-credential-manager.html" >Kubernetes Credential Manager</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.4.6</td>
            <td class="title-cell"><a href="conjur-credential-manager.html" >The Conjur credential manager</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.4.7</td>
            <td class="title-cell"><a href="creds-caching.html" >Caching credentials</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.4.8</td>
            <td class="title-cell"><a href="creds-redacting.html" >Redacting credentials</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.4.9</td>
            <td class="title-cell"><a href="creds-retry-logic.html" >Retrying failed fetches</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  

  

  



      </div>

      <div class="body-content">
        <div class="page-content">
          <div class="section" id="section_vault-credential-manager">
  
  <h1 class="section-header"><a class="anchor-target" name="vault-credential-manager" href="#vault-credential-manager"></a><span class="section-number">1.15.4.1 </span>The Vault credential manager</h1>
  

  <p>Concourse can be configured to pull credentials from a <a href="https://vaultproject.io">Vault</a> instance.</p><p>To configure this, first configure the URL of your Vault server by setting the following env on the <a href="concourse-web.html"><code>web</code> node</a>:</p><pre><code class="language-bash">CONCOURSE_VAULT_URL=https://vault.example.com:8200</code></pre><p>You may also need to configure the CA cert for Vault:</p><pre><code class="language-bash">CONCOURSE_VAULT_CA_CERT=path/to/ca.crt</code></pre><p>You&#39;ll also need to configure how the <code>web</code> node authenticates with Vault - see <a href="vault-credential-manager.html#authenticating-with-vault">Authenticating with Vault</a> for more details as that step is quite involved.</p>

  
    
      <div class="section" id="section_vault-credential-lookup-rules">
  
  <h2 class="section-header"><a class="anchor-target" name="vault-credential-lookup-rules" href="#vault-credential-lookup-rules"></a>Credential lookup rules</h2>
  

  <p>Vault lets you organize secrets into hierarchies, which is useful for when they should be accessible for particular pipelines or teams. When you have a parameter like <code>((foo))</code> in a pipeline definition, Concourse will (by default) look for it in the following paths, in order:</p><ul>

  <li><p><code>/concourse/TEAM_NAME/PIPELINE_NAME/foo</code></p></li>

  <li><p><code>/concourse/TEAM_NAME/foo</code></p></li>

</ul><p>Vault credentials are actually key-value, so for <code>((foo))</code> Concourse will default to the field name <code>value</code>. You can specify the field to grab via <code>.</code> syntax, e.g. <code>((foo.bar))</code>.</p><p>If you have multiple, intermediate levels in your path, you can use the <code>/</code> separator to reach your intended field, e.g. <code>((foo/bar/baz.qux))</code>.</p><p>When executing a one-off task, there is no pipeline: so in this case, only the team path <code>/concourse/TEAM_NAME/foo</code> is searched.</p><p>There are several ways to customize the lookup logic:</p><ol>

  <li><p>Add a &#34;shared path&#34;, for secrets common to all teams.</p></li>

  <li><p>Change the team- and pipeline-dependent path templates.</p></li>

  <li><p>Change the path prefix from <code>/concourse</code> to something else.</p></li>

  <li><p>Set a <a href="https://www.vaultproject.io/docs/enterprise/namespaces/">Vault namespace</a> for isolation within a Vault Enterprise installation.</p></li>

</ol><p>Each of these can be controlled by Concourse command line flags, or environment variables.</p>

  
    
      <div class="section" id="section_vault-shared-path">
  
  <h3 class="section-header"><a class="anchor-target" name="vault-shared-path" href="#vault-shared-path"></a>Configuring a shared path</h3>
  

  <p>A &#34;shared path&#34; can also be configured for credentials that you would like to share across all teams and pipelines, foregoing the default team/pipeline namespacing. Use with care!</p><pre><code class="language-bash">CONCOURSE_VAULT_SHARED_PATH=some-shared-path</code></pre><p>This path must exist under the configured path prefix. The above configuration would correspond to <code>/concourse/some-shared-path</code> with the default <code>/concourse</code> prefix.</p>

  
    
  
</div>
    
      <div class="section" id="section_vault-lookup-templates">
  
  <h3 class="section-header"><a class="anchor-target" name="vault-lookup-templates" href="#vault-lookup-templates"></a>Changing the path templates</h3>
  

  <p>You can choose your own list of templates, which will expand to team- or pipeline-specific paths. These are subject to the path prefix. By default, the templates used are:</p><pre><code class="language-bash">CONCOURSE_VAULT_LOOKUP_TEMPLATES=/{{.Team}}/{{.Pipeline}}/{{.Secret}},/{{.Team}}/{{.Secret}}</code></pre><p>When secrets are to be looked up, these are evaluated subject to the configured path prefix, where <code>{{.Team}}</code> expands to the current team, <code>{{.Pipeline}}</code> to the current pipeline (if any), and <code>{{.Secret}}</code> to the name of the secret. So if the settings are:</p><pre><code class="language-bash">CONCOURSE_VAULT_PATH_PREFIX=/secrets
CONCOURSE_VAULT_LOOKUP_TEMPLATES=/{{.Team}}/concourse/{{.Pipeline}}/{{.Secret}},/{{.Team}}/concourse/{{.Secret}},/common/{{.Secret}}</code></pre><p>and <code>((password))</code> is used in team <code>myteam</code> and pipeline <code>mypipeline</code>, Concourse will look for the following, in order:</p><ol>

  <li><p><code>/secrets/myteam/concourse/mypipeline/password</code></p></li>

  <li><p><code>/secrets/myteam/concourse/password</code></p></li>

  <li><p><code>/secrets/common/password</code></p></li>

</ol>

  
    
  
</div>
    
      <div class="section" id="section_vault-path-prefix">
  
  <h3 class="section-header"><a class="anchor-target" name="vault-path-prefix" href="#vault-path-prefix"></a>Changing the path prefix</h3>
  

  <p>The leading <code>/concourse</code> can be changed by specifying the following:</p><pre><code class="language-bash">CONCOURSE_VAULT_PATH_PREFIX=/some-other-prefix</code></pre>

  
    
  
</div>
    
      <div class="section" id="section_vault-namespace">
  
  <h3 class="section-header"><a class="anchor-target" name="vault-namespace" href="#vault-namespace"></a>Using a Vault namespace</h3>
  

  <p>If you are using Vault Enterprise, you can make secret lookups and authentication happen under a namespace.</p><pre><code class="language-bash">CONCOURSE_VAULT_NAMESPACE=chosen/namespace/path</code></pre><p>This setting applies to all teams equally.</p>

  
    
  
</div>
    
  
</div>
    
      <div class="section" id="section_configuring-the-secrets-engine">
  
  <h2 class="section-header"><a class="anchor-target" name="configuring-the-secrets-engine" href="#configuring-the-secrets-engine"></a>Configuring the secrets engine</h2>
  

  <p>Concourse is currently limited to looking under a single path, meaning enabling only one secrets engine is supported: <code>kv</code>, or <code>kv_v2</code>. This may change in the future - we&#39;re still collecting ideas in <a href="https://github.com/concourse/rfcs/pull/21">RFC #21</a>.</p><p>Using kv version 2 enables versioned secrets and the ability to restore previous versions or deleted secrets. Concourse will read the latest version of a secret at all times and if it is deleted it will appear as if the secret does not exist. More information regarding the Vault KV backend and the differences in versions can be found <a href="https://www.vaultproject.io/docs/secrets/kv">here</a>.</p><p>So, let&#39;s configure the <code>kv</code> secrets engine and mount it at <code>/concourse</code>:</p><pre><code class="language-bash">$ vault secrets enable -version=1 -path=concourse kv</code></pre><p>To enable kv_v2 and versioned secrets: <pre><code class="language-bash">$ vault secrets enable -version=2 -path=concourse kv</code></pre></p><p>Next, you&#39;ll want to create a policy to allow Concourse to read from this path.</p><pre><code class="language-hcl">path &#34;concourse/*&#34; {
  capabilities = [&#34;read&#34;]
}</code></pre><p>Save this to <code>concourse-policy.hcl</code>, and then run:</p><pre><code class="language-bash">vault policy write concourse ./concourse-policy.hcl</code></pre><p>This configuration will allow Concourse to read all credentials under <code>/concourse</code>. This should match your configured path prefix.</p>

  
    
  
</div>
    
      <div class="section" id="section_authenticating-with-vault">
  
  <h2 class="section-header"><a class="anchor-target" name="authenticating-with-vault" href="#authenticating-with-vault"></a>Authenticating with Vault</h2>
  

  <p>There are many ways to authenticate with a Vault server. The <code>web-node</code> can be configured with either a token or an arbitrary auth backend and arbitrary auth params, so just about all of them should be configurable.</p><p>When the <code>web</code> node acquires a token, either by logging in with an auth backend or by being given one directly, it will continuously renew the token to ensure it doesn&#39;t expire. The renewal interval is half of the token&#39;s lease duration.</p>

  
    
      <div class="section" id="section_vault-periodic-token">
  
  <h3 class="section-header"><a class="anchor-target" name="vault-periodic-token" href="#vault-periodic-token"></a>Using a periodic token</h3>
  

  <p>The simplest way to authenticate is by generating a periodic token:</p><pre><code class="language-bash">$ vault token create --policy concourse --period 1h
Key                Value
---                -----
token              s.mSNnbhGAqxK2ZbMasOQ91rIA
token_accessor     0qsib5YcYvROm86cT08IFxIT
token_duration     1h
token_renewable    true
token_policies     [concourse default]</code></pre><div class="warning">
  <p>Choose your <code>--period</code> wisely, as the timer starts counting down as soon as the token is created. You should also use a duration long enough to account for any planned <code>web</code> node downtime.</p>
</div><p>Once you have the token, just set the following env on the <code>web</code> node:</p><pre><code class="language-bash">CONCOURSE_VAULT_CLIENT_TOKEN=s.mSNnbhGAqxK2ZbMasOQ91rIA</code></pre><p>Periodic tokens are the quickest way to get started, but they have one fatal flaw: if the <code>web</code> node is down for longer than the token&#39;s configured period, the token will expire and a new one will have to be created and configured. This can be avoided by using the <a href="vault-credential-manager.html#vault-approle-auth"><code>approle</code> auth backend</a>.</p>

  
    
  
</div>
    
      <div class="section" id="section_vault-approle-auth">
  
  <h3 class="section-header"><a class="anchor-target" name="vault-approle-auth" href="#vault-approle-auth"></a>Using the <code>approle</code> auth backend</h3>
  

  <p>The <a href="https://www.vaultproject.io/docs/auth/approle.html"><code>approle</code></a> backend allows for an <em>app</em> (in this case, Concourse) to authenticate with a <em>role</em> pre-configured in Vault.</p><p>With this backend, the <a href="concourse-web.html"><code>web</code> node</a> is configured with a <code>role_id</code> corresponding to a pre-configured role, and a <code>secret_id</code> which is used to authenticate and acquire a token.</p><p>The <code>approle</code> backend must first be configured in Vault. Vault&#39;s <code>approle</code> backend allows for a few parameters which you may want to set to determine the permissions and lifecycle of its issued tokens:</p><dl>
  
  <dt><code>policies=names</code></dt>
    <dd><p>This determines the policies (comma-separated) to set on each token. Be sure to set one that has access to the secrets path - see <a href="vault-credential-manager.html#configuring-the-secrets-engine">Configuring the secrets engine</a> for more information.</p></dd>
  
  <dt><code>token_ttl=duration</code></dt>
    <dd><p>This determines the TTL for each token granted. The token can be continuously renewed, as long as it is renewed before the TTL elapses.</p></dd>
  
  <dt><code>token_max_ttl=duration</code></dt>
    <dd><p>This sets a maximum lifetime for each token, after which the token can no longer be renewed.</p><p>If configured, be sure to set the same value on the <code>web</code> node so that it can re-auth before this duration is reached:</p><pre><code class="language-bash">CONCOURSE_VAULT_AUTH_BACKEND_MAX_TTL=1h</code></pre></dd>
  
  <dt><code>period=duration</code></dt>
    <dd><p>If configured, tokens issued will be <a href="https://www.vaultproject.io/docs/concepts/tokens.html#periodic-tokens"><em>periodic</em></a>. Periodic tokens are not bound by any configured max TTL, and can be renewed continuously. It does not make sense to configure both <code>period</code> and <code>token_max_ttl</code> as the max TTL will be ignored.</p></dd>
  
  <dt><code>token_num_uses=count</code></dt>
    <dd><p>This sets a limit on how often a token can be used. <strong>We do not recommend setting this value</strong>, as it will effectively hamstring Concourse after a few credential acquisitions. The <code>web</code> node does not currently know to re-acquire a token when this limit is reached.</p></dd>
  
  <dt><code>secret_id_ttl=duration</code> and <code>secret_id_num_uses=count</code></dt>
    <dd><p>These two configurations will result in the secret ID expiring after the configured time or configured number of log-ins, respectively.</p><p>You should only set these if you have something periodically re-generating secret IDs and re-configuring your <code>web</code> nodes accordingly.</p></dd>
  
</dl><p>Given all that, a typical configuration may look something like this:</p><pre><code class="language-bash">$ vault auth enable approle
Success! Enabled approle auth method at: approle/
$ vault write auth/approle/role/concourse policies=concourse period=1h
Success! Data written to: auth/approle/role/concourse</code></pre><p>Now that the backend is configured, we&#39;ll need to obtain the <code>role_id</code> and generate a <code>secret_id</code>:</p><pre><code class="language-bash">$ vault read auth/approle/role/concourse/role-id
Key        Value
---        -----
role_id    5f3420cd-3c66-2eff-8bcc-0e8e258a7d18
$ vault write -f auth/approle/role/concourse/secret-id
Key                   Value
---                   -----
secret_id             f7ec2ac8-ad07-026a-3e1c-4c9781423155
secret_id_accessor    1bd17fc6-dae1-0c82-d325-3b8f9b5654ee</code></pre><p>These should then be set on the <a href="concourse-web.html"><code>web</code> node</a> like so:</p><pre><code class="language-bash">CONCOURSE_VAULT_AUTH_BACKEND=&#34;approle&#34;
CONCOURSE_VAULT_AUTH_PARAM=&#34;role_id:5f3420cd-3c66-2eff-8bcc-0e8e258a7d18,secret_id:f7ec2ac8-ad07-026a-3e1c-4c9781423155&#34;</code></pre>

  
    
  
</div>
    
      <div class="section" id="section_vault-cert-auth">
  
  <h3 class="section-header"><a class="anchor-target" name="vault-cert-auth" href="#vault-cert-auth"></a>Using the <code>cert</code> auth backend</h3>
  

  <p>The <a href="https://www.vaultproject.io/docs/auth/cert.html"><code>cert</code></a> auth method allows authentication using SSL/TLS client certificates.</p><p>With this backend, the <a href="concourse-web.html"><code>web</code> node</a> is configured with a client cert and a client key. Vault must be configured with TLS, which you should be almost certainly be doing anyway.</p><p>The <code>cert</code> backend must first be configured in Vault. The backend is associated to a policy and a CA cert used to verify the client certificate. It may also be given the client certificate itself.</p><p>The <code>cert</code> backend must first be configured in Vault. Vault&#39;s <code>cert</code> backend allows for a few parameters which you may want to set to determine the lifecycle of its issued tokens:</p><dl>
  
  <dt><code>policies=names</code></dt>
    <dd><p>This determines the policies (comma-separated) to set on each token. Be sure to set one that has access to the secrets path - see <a href="vault-credential-manager.html#configuring-the-secrets-engine">Configuring the secrets engine</a> for more information.</p></dd>
  
  <dt><code>ttl=duration</code></dt>
    <dd><p>This determines the TTL for each token granted. The token can be continuously renewed, as long as it is renewed before the TTL elapses.</p></dd>
  
  <dt><code>max_ttl=duration</code></dt>
    <dd><p>This sets a maximum lifetime for each token, after which the token can no longer be renewed.</p><p>If configured, be sure to set the same value on the <code>web</code> node so that it can re-auth before this duration is reached:</p><pre><code class="language-bash">CONCOURSE_VAULT_AUTH_BACKEND_MAX_TTL=1h</code></pre></dd>
  
  <dt><code>period=duration</code></dt>
    <dd><p>If configured, tokens issued will be <a href="https://www.vaultproject.io/docs/concepts/tokens.html#periodic-tokens"><em>periodic</em></a>. Periodic tokens are not bound by any configured max TTL, and can be renewed continuously. It does not make sense to configure both <code>period</code> and <code>max_ttl</code> as the max TTL will be ignored.</p></dd>
  
</dl><pre><code class="language-bash">$ vault auth enable cert
Success! Enabled cert auth method at: cert/
$ vault write auth/cert/certs/concourse policies=concourse certificate=@out/vault-ca.crt ttl=1h
Success! Data written to: auth/cert/certs/concourse</code></pre><p>Once that&#39;s all set up, you&#39;ll just need to configure the client cert and key on the <code>web</code> node like so:</p><pre><code class="language-bash">CONCOURSE_VAULT_AUTH_BACKEND=&#34;cert&#34;
CONCOURSE_VAULT_CLIENT_CERT=vault-certs/concourse.crt
CONCOURSE_VAULT_CLIENT_KEY=vault-certs/concourse.key</code></pre><p>In this case no additional auth params are necessary, as the Vault&#39;s TLS auth backend will check the certificate against all roles if no name is specified.</p>

  
    
  
</div>
    
  
</div>
    
  
</div>

          <nav class="prev-next">
          
            <div class="prev">
              prev:

              
              <span class="section-number">1.15.4</span>
              

              <a href="creds.html">Credential Management</a>
            </div>
          

          
            <div class="next">
              next:

              
              <span class="section-number">1.15.4.2</span>
              

              <a href="credhub-credential-manager.html">The CredHub credential manager</a>
            </div>
          
          </nav>
        </div>

        <div class="page-aside">
          <div class="page-partial">
            <div class="content">
  <h2>Examples</h2>

  <div class="example">
  <h3>Docker Compose, Vault, <code>cert</code> auth</h3>

  <p>Configuring Vault with TLS cert-based auth involves a few moving parts. The following example is not really meant for production, but hopefully it makes everything easier to understand by seeing how all the parts fit together.</p><p>First, grab the Docker Compose quick-start:</p><pre><code class="language-bash">$ wget https://concourse-ci.org/docker-compose.yml</code></pre><p>Next, let&#39;s generate all the certificates using <a href="https://github.com/square/certstrap"><code>certstrap</code></a> like so:</p><pre><code class="language-bash">certstrap init --cn vault-ca
certstrap request-cert --domain vault --ip 127.0.0.1
certstrap sign vault --CA vault-ca
certstrap request-cert --cn concourse
certstrap sign concourse --CA vault-ca
mv out vault-certs</code></pre><p>Next we&#39;ll configure the Vault server to use the certs we made by creating <code>vault-config/config.hcl</code>:</p><pre><code class="language-hcl">listener &#34;tcp&#34; {
  address = &#34;0.0.0.0:8200&#34;
  tls_cert_file = &#34;/vault/certs/vault.crt&#34;
  tls_key_file = &#34;/vault/certs/vault.key&#34;
}

storage &#34;file&#34; {
  path = &#34;/vault/file&#34;
}</code></pre><p>Next, let&#39;s create a <code>docker-compose.override.yml</code> override that will add Vault and configure cert-based auth:</p><pre><code class="language-yaml">version: &#39;3&#39;

services:
  concourse:
    volumes:
    - ./vault-certs:/vault-certs
    environment:
      CONCOURSE_VAULT_URL: https://vault:8200
      CONCOURSE_VAULT_AUTH_BACKEND: cert
      CONCOURSE_VAULT_CA_CERT: /vault-certs/vault-ca.crt
      CONCOURSE_VAULT_CLIENT_CERT: /vault-certs/concourse.crt
      CONCOURSE_VAULT_CLIENT_KEY: /vault-certs/concourse.key

  vault:
    image: vault
    cap_add: [IPC_LOCK]
    ports: [&#34;8200:8200&#34;]
    volumes:
    - ./vault-certs:/vault/certs
    - ./vault-config:/vault/config
    command: server</code></pre><p>From here, we just need to spin up the cluster:</p><pre><code class="language-bash">$ docker-compose up</code></pre><p>And...now everything should start blowing up! Vault is still sealed, so <a href="concourse-web.html"><code>web</code> node</a> can&#39;t log in.</p><p>Let&#39;s initialize Vault:</p><pre><code class="language-bash">$ export VAULT_CACERT=$PWD/vault-certs/vault-ca.crt
$ vault operator init</code></pre><p>Make note of the 5 unseal keys and the root token, then run the following:</p><pre><code class="language-bash">$ vault operator unseal # paste unseal key 1
$ vault operator unseal # paste unseal key 2
$ vault operator unseal # paste unseal key 3
$ vault login           # paste root token</code></pre><p>At this point Vault is unsealed and ready to go, except we haven&#39;t configured the <code>cert</code> backend yet.</p><p>First let&#39;s create a policy for Concourse, <code>concourse-policy.hcl</code>:</p><pre><code class="language-hcl">path &#34;concourse/*&#34; {
  policy = &#34;read&#34;
}</code></pre><p>Save this to <code>concourse-policy.hcl</code>, and then run:</p><pre><code class="language-bash">$ vault policy write concourse ./concourse-policy.hcl
Success! Uploaded policy: concourse
$ vault auth enable cert
Success! Enabled cert auth method at: cert/
$ vault write auth/cert/certs/concourse \
    policies=concourse \
    certificate=@vault-certs/vault-ca.crt \
    ttl=1h</code></pre><p>At this point the <code>web</code> node should be able to log in successfully.</p>
</div>
</div>
          </div>
          </div>
      </div>
    </div>

    <ul class="improve-docs">
      <li><img src="images/icons/github-box.svg" /> <a href="https://github.com/concourse/docs">help improve this site</a></li>
      <li><img src="images/booklit.svg" /> powered by <a href="https://vito.github.io/booklit">Booklit</a></li>
    </ul>
  </body>
</html>