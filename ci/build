#!/bin/bash

set -e -x

apk add git

git config --global user.email "concourseteam+concourse-github-bot@gmail.com"
git config --global user.name "Concourse Bot"

# Change to the docs repo
pushd docs
  # Install dependencies
  pip install zensical nodeenv
  nodeenv env --node=22.21.1
  npm ci

  # Remove apps before build
  rm -rf docs/libs/examples/apps/
  rm -rf docs/libs/examples/**/*.md

  # Create site directory
  npm run build

  # Copy well-known for BlueSky
  cp -R .well-known site/.well-known

  if [ -e .git ]; then
    git checkout gh-pages
    git rm -rf .

    rm -rf venv/ node_modules/ env/ .cache/ overrides/ docs/ .idea/

    mv site/{.,}* .
    rmdir site

    # Create CNAME file
    echo -n "concourse-ci.org" > CNAME

    # Create robots.txt file
    echo "User-agent: *" > robots.txt
    echo -n "Disallow: /single-page.html" >> robots.txt

    git add -A
    git commit --allow-empty -m "build"
  fi
popd
