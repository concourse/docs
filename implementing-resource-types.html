<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=775" />
<title>Implementing a Resource Type - Concourse CI</title>
<link rel="stylesheet" type="text/css" href="css/normalize.css" />
<link rel="stylesheet" type="text/css" href="css/pipeline.css" />
<link rel="stylesheet" type="text/css" href="css/iosevka.css" />
<link rel="stylesheet" type="text/css" href="css/booklit.css" />
<link rel="stylesheet" type="text/css" href="css/prism.css" />
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
<link href="https://fonts.googleapis.com/css?family=Barlow:400,400i,700|Roboto+Slab:300,400,700" rel="stylesheet" />
<script src="js/search.js"></script>
<script async type="text/javascript" src="js/prism.js"></script>
<script data-goatcounter="https://concourse.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  </head>
  <body>
    

<div class="page-top">
  <nav class="top-nav">
    <a class="top-link logo-link" href="/"><img src="images/logo-white.svg" />Concourse</a>
    
    <a class="top-link active" href="docs.html">Docs</a>
    
    <a class="top-link" href="examples.html">Examples</a>
    
    <a class="top-link" href="project.html">Project</a>
    
    <a class="top-link" href="ecosystem.html">Ecosystem</a>
    
    <a class="top-link" href="https://resource-types.concourse-ci.org">Resource Types</a>
    <a class="top-link" href="https://blog.concourse-ci.org">blog</a>
    <a class="top-link" href="https://github.com/concourse/concourse/discussions">discuss</a>

    <div id="search"></div>

    <script type="text/javascript">
      var app = Elm.Main.init({
        node: document.getElementById('search')
      });

      app.ports.emitSearchTerm.subscribe(function(term) {
        goatcounter.count({
          path: "search:" + term,
          title: "user searched: " + term,
          event: true
        });
      });
    </script>
  </nav>
</div>

    <div class="page-body">
      <div class="page-nav">
        






  
  
  
  
  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1</span><a href="docs.html"  class="active">Docs</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.1</td>
            <td class="title-cell"><a href="getting-started.html" >Getting Started</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.2</td>
            <td class="title-cell"><a href="install.html" >Install</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.3</td>
            <td class="title-cell"><a href="auth.html" >Auth &amp; Teams</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.4</td>
            <td class="title-cell"><a href="fly.html" >The <code>fly</code> CLI</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.5</td>
            <td class="title-cell"><a href="config-basics.html" >Config Basics</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.6</td>
            <td class="title-cell"><a href="pipelines.html" >Pipelines</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.7</td>
            <td class="title-cell"><a href="vars.html" >Vars</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.8</td>
            <td class="title-cell"><a href="resources.html" >Resources</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.9</td>
            <td class="title-cell"><a href="resource-types.html"  class="active">Resource Types</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.10</td>
            <td class="title-cell"><a href="jobs.html" >Jobs</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.11</td>
            <td class="title-cell"><a href="steps.html" >Steps</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.12</td>
            <td class="title-cell"><a href="tasks.html" >Tasks</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.13</td>
            <td class="title-cell"><a href="builds.html" >Builds</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.14</td>
            <td class="title-cell"><a href="how-to-guides.html" >How-To Guides</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15</td>
            <td class="title-cell"><a href="operation.html" >Operation</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.16</td>
            <td class="title-cell"><a href="observation.html" >Observation</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.17</td>
            <td class="title-cell"><a href="internals.html" >Internals</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  

  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1.9</span><a href="resource-types.html"  class="active">Resource Types</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.9.1</td>
            <td class="title-cell"><a href="implementing-resource-types.html"  class="self">Implementing a Resource Type</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.9.2</td>
            <td class="title-cell"><a href="managing-resource-types.html" >Managing Resource Types</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  

  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1.9.1</span><a href="implementing-resource-types.html"  class="self">Implementing a Resource Type</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.9.1.1</td>
            <td class="title-cell"><a href="implementing-resource-types.html#resource-check" ><code>check</code>: Check for new versions.</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.9.1.2</td>
            <td class="title-cell"><a href="implementing-resource-types.html#resource-in" ><code>in</code>: Fetch a given resource.</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.9.1.3</td>
            <td class="title-cell"><a href="implementing-resource-types.html#resource-out" ><code>out</code>: Update a resource.</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.9.1.4</td>
            <td class="title-cell"><a href="implementing-resource-types.html#resource-metadata" >Metadata</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.9.1.5</td>
            <td class="title-cell"><a href="implementing-resource-types.html#resource-certs" >Certificate Propagation</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.9.1.6</td>
            <td class="title-cell"><a href="implementing-resource-types.html#test-resource-with-docker" >Testing resources locally using docker</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  



      </div>

      <div class="body-content">
        <div class="page-content">
          <div class="section" id="section_implementing-resource-types">
  
  <h1 class="section-header"><a class="anchor-target" name="implementing-resource-types" href="#implementing-resource-types"></a><span class="section-number">1.9.1 </span>Implementing a Resource Type</h1>
  

  <p>A resource type is implemented by a container image with three scripts:</p><ul>

  <li><p><code>/opt/resource/check</code> for checking for new versions of the resource</p></li>

  <li><p><code>/opt/resource/in</code> for pulling a version of the resource down</p></li>

  <li><p><code>/opt/resource/out</code> for idempotently pushing a version up</p></li>

</ul><p>Distributing resource types as containers allows them to package their own dependencies. For example, the <code>git</code> resource comes with the <code>git</code> binary pre-installed.</p><p>All resources must implement all three actions, though the actions can just be no-ops (which still must be correctly implemented as detailed below).</p><p>Resources can emit logs to the user by writing to <code>stderr</code>. ANSI escape codes (coloring, cursor movement, etc.) will be interpreted properly by the web UI, so you should make your output pretty.</p>

  
    
      <div class="section" id="section_resource-check">
  
  <h2 class="section-header"><a class="anchor-target" name="resource-check" href="#resource-check"></a><code>check</code>: Check for new versions.</h2>
  

  <p>A resource type&#39;s <code>check</code> script is invoked to detect new versions of the resource. It is given the configured source and current version on <code>stdin</code>, and must print the array of new versions, in chronological order (oldest first), to <code>stdout</code>, including the requested version if it&#39;s still valid.</p><p>The request body will have the following fields:</p><ul>

  <li><p><code>source</code> is an arbitrary JSON object which specifies the location of the resource, including any credentials. This is passed verbatim from the <a href="resources.html">resource configuration</a>.</p><p>For the <code>git</code> resource this would be the repo URI, the branch, and the private key, if necessary.</p></li>

  <li><p><code>version</code> is a JSON object with <code>string</code> fields, used to uniquely identify an instance of the resource. For <code>git</code> this would be the commit&#39;s SHA.</p><p>This will be omitted from the first request, in which case the resource should return the current version (<em>not</em> every version since the resource&#39;s inception).</p></li>

</ul><p>For example, here&#39;s what the input for the <code>git</code> resource may look like:</p><pre><code class="language-json">{
  &#34;source&#34;: {
    &#34;uri&#34;: &#34;git://some-uri&#34;,
    &#34;branch&#34;: &#34;develop&#34;,
    &#34;private_key&#34;: &#34;...&#34;
  },
  &#34;version&#34;: { &#34;ref&#34;: &#34;61cbef&#34; }
}</code></pre><p>Upon receiving this payload the <code>git</code> resource would probably do something like:</p><pre><code class="language-bash">[ -d /tmp/repo ] || git clone git://some-uri /tmp/repo
cd /tmp/repo
git pull &amp;&amp; git log 61cbef..HEAD</code></pre><p>Note that it conditionally clones; the container for checking versions is reused between checks, so that it can efficiently pull rather than cloning every time.</p><p>And the output, assuming <code>d74e01</code> is the commit immediately after <code>61cbef</code>:</p><pre><code class="language-json">[
  { &#34;ref&#34;: &#34;61cbef&#34; },
  { &#34;ref&#34;: &#34;d74e01&#34; },
  { &#34;ref&#34;: &#34;7154fe&#34; }
]</code></pre><p>The list may be empty, if there are no versions available at the source. If the given version is already the latest, an array with that version as the sole entry should be listed.</p><p>If your resource is unable to determine which versions are newer than the given version (e.g. if it&#39;s a git commit that was <code>push -f</code>ed over), then the current version of your resource should be returned (i.e. the new <code>HEAD</code>).</p>

  
    
  
</div>
    
      <div class="section" id="section_resource-in">
  
  <h2 class="section-header"><a class="anchor-target" name="resource-in" href="#resource-in"></a><code>in</code>: Fetch a given resource.</h2>
  

  <p>The <code>in</code> script is passed a destination directory as command line argument <code>$1</code>, and is given on <code>stdin</code> the configured source and a precise version of the resource to fetch.</p><p>The script must fetch the resource and place it in the given directory.</p><p>If the desired resource version is unavailable (for example, if it was deleted), the script must exit with error.</p><p>The script must emit the fetched version, and may emit metadata as a list of key-value pairs. This data is intended for public consumption and will make it upstream, intended to be shown on the build&#39;s page.</p><p>The request will contain the following fields:</p><ul>

  <li><p><code>source</code> is the same value as passed to <a href="implementing-resource-types.html#resource-check"><code>check</code></a>.</p></li>

  <li><p><code>version</code> is the same type of value passed to <a href="implementing-resource-types.html#resource-check"><code>check</code></a>, and specifies the version to fetch.</p></li>

  <li><p><code>params</code> is an arbitrary JSON object passed along verbatim from <a href="get-step.html#schema.get.params"><code>get</code> step <strong><code>params</code></strong></a> on a <a href="get-step.html"><code>get</code> step</a>.</p></li>

</ul><p>Example request, in this case for the <code>git</code> resource:</p><pre><code class="language-json">{
  &#34;source&#34;: {
    &#34;uri&#34;: &#34;git://some-uri&#34;,
    &#34;branch&#34;: &#34;develop&#34;,
    &#34;private_key&#34;: &#34;...&#34;
  },
  &#34;version&#34;: { &#34;ref&#34;: &#34;61cebf&#34; }
}</code></pre><p>Upon receiving this payload the <code>git</code> resource would probably do something like:</p><pre><code class="language-bash">git clone --branch develop git://some-uri $1
cd $1
git checkout 61cebf</code></pre><p>And output:</p><pre><code class="language-json">{
  &#34;version&#34;: { &#34;ref&#34;: &#34;61cebf&#34; },
  &#34;metadata&#34;: [
    { &#34;name&#34;: &#34;commit&#34;, &#34;value&#34;: &#34;61cebf&#34; },
    { &#34;name&#34;: &#34;author&#34;, &#34;value&#34;: &#34;Hulk Hogan&#34; }
  ]
}</code></pre>

  
    
  
</div>
    
      <div class="section" id="section_resource-out">
  
  <h2 class="section-header"><a class="anchor-target" name="resource-out" href="#resource-out"></a><code>out</code>: Update a resource.</h2>
  

  <p>The <code>out</code> script is passed a path to the directory containing the build&#39;s full set of sources as command line argument <code>$1</code>, and is given on <code>stdin</code> the configured params and the resource&#39;s source configuration.  </p><p>The script must emit the resulting version of the resource. For example, the <code>git</code> resource emits the SHA of the commit that it has just pushed.</p><p>Additionally, the script may emit metadata as a list of key-value pairs. This data is intended for public consumption and will make it upstream, intended to be shown on the build&#39;s page.</p><p>The request will contain the following fields:</p><ul>

  <li><p><code>source</code> is the same value as passed to <a href="implementing-resource-types.html#resource-check"><code>check</code></a>.</p></li>

  <li><p><code>params</code> is an arbitrary JSON object passed along verbatim from <a href="get-step.html#schema.get.params"><code>get</code> step <strong><code>params</code></strong></a> on a <a href="put-step.html"><code>put</code> step</a>.</p></li>

</ul><p>Example request, in this case for the <code>git</code> resource:</p><pre><code class="language-json">{
  &#34;params&#34;: {
    &#34;branch&#34;: &#34;develop&#34;,
    &#34;repo&#34;: &#34;some-repo&#34;
  },
  &#34;source&#34;: {
    &#34;uri&#34;: &#34;git@...&#34;,
    &#34;private_key&#34;: &#34;...&#34;
  }
}</code></pre><p>Upon receiving this payload the <code>git</code> resource would probably do something like:</p><pre><code class="language-bash">cd $1/some-repo
git push origin develop</code></pre><p>And output:</p><pre><code class="language-json">{
  &#34;version&#34;: { &#34;ref&#34;: &#34;61cebf&#34; },
  &#34;metadata&#34;: [
    { &#34;name&#34;: &#34;commit&#34;, &#34;value&#34;: &#34;61cebf&#34; },
    { &#34;name&#34;: &#34;author&#34;, &#34;value&#34;: &#34;Mick Foley&#34; }
  ]
}</code></pre>

  
    
  
</div>
    
      <div class="section" id="section_resource-metadata">
  
  <h2 class="section-header"><a class="anchor-target" name="resource-metadata" href="#resource-metadata"></a>Metadata</h2>
  

  <p>When used in a <a href="get-step.html"><code>get</code> step</a> or a <a href="put-step.html"><code>put</code> step</a>, metadata about the running build is made available via the following environment variables:</p><dl>
  
  <dt><code>$BUILD_ID</code></dt>
    <dd><p>The internal identifier for the build. Right now this is numeric, but it may become a UUID in the future. Treat it as an absolute reference to the build.</p></dd>
  
  <dt><code>$BUILD_NAME</code></dt>
    <dd><p>The build number within the build&#39;s job.</p></dd>
  
  <dt><code>$BUILD_JOB_NAME</code></dt>
    <dd><p>The name of the build&#39;s job.</p></dd>
  
  <dt><code>$BUILD_PIPELINE_NAME</code></dt>
    <dd><p>The name of the pipeline that the build&#39;s job lives in.</p></dd>
  
  <dt><code>$BUILD_PIPELINE_INSTANCE_VARS</code></dt>
    <dd><p>The instance vars of the instanced pipeline that the build&#39;s job lives in, serialized as JSON. See <a href="instanced-pipelines.html">Grouping Pipelines</a> for a definition of instanced pipelines.</p></dd>
  
  <dt><code>$BUILD_TEAM_NAME</code></dt>
    <dd><p>The team that the build belongs to.</p></dd>
  
  <dt><code>$BUILD_CREATED_BY</code></dt>
    <dd><p>The username that created the build. By default it is not available. See <a href="resources.html#schema.resource.expose_build_created_by"><code>expose_build_created_by</code></a> for how to opt in. This metadata field is not made available to the <a href="get-step.html"><code>get</code> step</a>.</p></dd>
  
  <dt><code>$ATC_EXTERNAL_URL</code></dt>
    <dd><p>The public URL for your ATC; useful for debugging.</p></dd>
  
</dl><p>If the build is a one-off, <code>$BUILD_NAME</code>, <code>$BUILD_JOB_NAME</code>, <code>$BUILD_PIPELINE_NAME</code>, and <code>$BUILD_PIPELINE_INSTANCE_VARS</code> will not be set.</p><p>Additionally, <code>$BUILD_PIPELINE_INSTANCE_VARS</code> will not be set if the build&#39;s pipeline has no instance vars (i.e. is not an instanced pipeline).</p><p>None of these variables are available to <a href="implementing-resource-types.html#resource-check"><code>check</code></a>.</p><p>These variables should be used solely for annotating things with metadata for traceability, i.e. for linking to the build in an alert or annotating an automated commit to facilitate its origin discovery.</p><p>They should <em>not</em> be used to emulate versioning (e.g. by using the increasing build number). They are not provided to <a href="task-step.html"><code>task</code> step</a>s to avoid this anti-pattern.</p>

  
    
  
</div>
    
      <div class="section" id="section_resource-certs">
  
  <h2 class="section-header"><a class="anchor-target" name="resource-certs" href="#resource-certs"></a>Certificate Propagation</h2>
  

  <p>Certificates can be automatically propagated into each resource container, if the worker is configured to do so. The BOSH release configures this automatically, while the <code>concourse</code> binary must be given a <code>--certs-dir</code> flag pointing to the path containing the CA certificate bundle.</p><p>The worker&#39;s certificate directory will then be always mounted at <code>/etc/ssl/certs</code>, read-only, in each resource container created on the worker. There&#39;s no single standard path for this, so we picked one that would work out of the box in most cases.</p><p>This approach to certificate configuration is similar in mindset to the propagation of <code>http_proxy</code>/<code>https_proxy</code> - certs are kind of a baseline assumption when deploying software, so Concourse should do its best to respect it out-of-the-box, especially as they&#39;re often used in tandem with a man-in-the-middle corporate SSL proxy. (In this way it doesn&#39;t feel too much like the anti-pattern of hand-tuning workers.)</p>

  
    
  
</div>
    
      <div class="section" id="section_test-resource-with-docker">
  
  <h2 class="section-header"><a class="anchor-target" name="test-resource-with-docker" href="#test-resource-with-docker"></a>Testing resources locally using docker</h2>
  

  <p>To test an already packaged resource (a docker image) outside concourse, you need to: <ol>

  <li><p>If, for instance, you are testing the <code>out</code> behaviour of the <code>git</code> resource, create a json file with <code>source</code> configuration of the resource and the <code>params</code> the <code>put</code> step expects. Such a file for the <code>git</code> resource would contain the following (or similar): <pre><code class="language-json">{
  &#34;source&#34;: {
    &#34;uri&#34;: &#34;git://some-uri&#34;,
    &#34;branch&#34;: &#34;develop&#34;,
    &#34;private_key&#34;: &#34;...&#34;
  },
  &#34;params&#34;: {
    &#34;repository&#34;: &#34;.&#34;,
    &#34;rebase&#34;: true
  }
}</code></pre> Save this file to <code>out-config.json</code> in your working directory.</p></li>

  <li><p>Then run the <code>/opt/resource/out</code> script with its inputs provided via <code>stdin</code> like so (using the <code>docker</code> cli as an example): <pre><code class="language-bash">docker run --rm -i -v &#34;${PWD}:${PWD}&#34; -w &#34;${PWD}&#34; concourse/git-resource /opt/resource/out . &lt; out-config.json</code></pre></p></li>

</ol> <div class="warning">
  This example needs modification depending on the resource you are testing and your local environment. See the notes below for details.
</div> <ol>

  <li><p>If you use the exact configuration in this example, the git resource will print an error about the format of the private key being invalid. Adjust the content <code>out-config.json</code> as necessary to get it working with your resource.</p></li>

  <li><p>If the resource you are testing uses <a href="implementing-resource-types.html#resource-metadata">Metadata</a>, you will need to provide the required metadata as environment variables to your <code>docker run</code> command like so: <pre><code class="language-bash">docker run --rm -i -e ATC_EXTERNAL_URL=&#34;https://concourse.example.com&#34; -e BUILD_NAME=620 -v &#34;${PWD}:${PWD}&#34; -w &#34;${PWD}&#34; concourse/git-resource /opt/resource/out . &lt; out-config.json</code></pre></p></li>

</ol></p>

  
    
  
</div>
    
  
</div>

          <nav class="prev-next">
          
            <div class="prev">
              prev:

              
              <span class="section-number">1.9</span>
              

              <a href="resource-types.html">Resource Types</a>
            </div>
          

          
            <div class="next">
              next:

              
              <span class="section-number">1.9.2</span>
              

              <a href="managing-resource-types.html">Managing Resource Types</a>
            </div>
          
          </nav>
        </div>

        <div class="page-aside"></div>
      </div>
    </div>

    <ul class="improve-docs">
      <li><img src="images/icons/github-box.svg" /> <a href="https://github.com/concourse/docs">help improve this site</a></li>
      <li><img src="images/booklit.svg" /> powered by <a href="https://vito.github.io/booklit">Booklit</a></li>
    </ul>
  </body>
</html>