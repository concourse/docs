<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=775" />
<title>Garbage Collector - Concourse CI</title>
<link rel="stylesheet" type="text/css" href="css/normalize.css" />
<link rel="stylesheet" type="text/css" href="css/pipeline.css" />
<link rel="stylesheet" type="text/css" href="css/iosevka.css" />
<link rel="stylesheet" type="text/css" href="css/booklit.css" />
<link rel="stylesheet" type="text/css" href="css/prism.css" />
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
<link href="https://fonts.googleapis.com/css?family=Barlow:400,400i,700|Roboto+Slab:300,400,700" rel="stylesheet" />
<script src="js/search.js"></script>
<script async type="text/javascript" src="js/prism.js"></script>
<script data-goatcounter="https://concourse.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  </head>
  <body>
    <div class="page-top">
      <nav class="top-nav">
  <a class="top-link logo-link" href="/"><img src="images/logo-white.svg" />Concourse</a>
  
  <a class="top-link active" href="docs.html">Docs</a>
  
  <a class="top-link" href="examples.html">Examples</a>
  
  <a class="top-link" href="project.html">Project</a>
  
  <a class="top-link" href="https://resource-types.concourse-ci.org">Resource Types</a>
  <a class="top-link" href="https://blog.concourse-ci.org">blog</a>
  <a class="top-link" href="https://github.com/concourse/concourse/discussions">discuss</a>

  <div id="search"></div>

  <script type="text/javascript">
    var app = Elm.Main.init({
      node: document.getElementById('search')
    });

    app.ports.emitSearchTerm.subscribe(function(term) {
      goatcounter.count({
        path: "search:" + term,
        title: "user searched: " + term,
        event: true
      });
    });
  </script>
</nav>
    </div>

    <div class="page-body">
      <div class="page-nav">
        






  
  
  
  
  
  
  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1</span><a href="docs.html"  class="active">Docs</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.1</td>
            <td class="title-cell"><a href="install.html" >Install</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.2</td>
            <td class="title-cell"><a href="auth.html" >Auth &amp; Teams</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.3</td>
            <td class="title-cell"><a href="fly.html" >The <code>fly</code> CLI</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.4</td>
            <td class="title-cell"><a href="config-basics.html" >Config Basics</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.5</td>
            <td class="title-cell"><a href="pipelines.html" >Pipelines</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.6</td>
            <td class="title-cell"><a href="vars.html" >Vars</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.7</td>
            <td class="title-cell"><a href="resources.html" >Resources</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.8</td>
            <td class="title-cell"><a href="resource-types.html" >Resource Types</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.9</td>
            <td class="title-cell"><a href="jobs.html" >Jobs</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.10</td>
            <td class="title-cell"><a href="tasks.html" >Tasks</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.11</td>
            <td class="title-cell"><a href="builds.html" >Builds</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.12</td>
            <td class="title-cell"><a href="operation.html" >Operation</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.13</td>
            <td class="title-cell"><a href="observation.html" >Observation</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.14</td>
            <td class="title-cell"><a href="internals.html"  class="active">Internals</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  

  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1.14</span><a href="internals.html"  class="active">Internals</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.14.1</td>
            <td class="title-cell"><a href="internals.html#basic-architecture" >Basic architecture</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.14.2</td>
            <td class="title-cell"><a href="internals.html#component-atc"  class="active">ATC: web UI &amp; build scheduler</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.14.3</td>
            <td class="title-cell"><a href="internals.html#component-tsa" >TSA: worker registration &amp; forwarding</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.14.4</td>
            <td class="title-cell"><a href="internals.html#architecture-worker" >Workers: container runtime &amp; cache management</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  

  

  
  <div class="context">
    <nav>
      <div class="top">
        <a href="internals.html#component-atc"  class="active">ATC: web UI &amp; build scheduler</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.14.2.1</td>
            <td class="title-cell"><a href="checker.html" >Resource Checker</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.14.2.2</td>
            <td class="title-cell"><a href="scheduler.html" >Build Scheduler</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.14.2.3</td>
            <td class="title-cell"><a href="build-tracker.html" >Build Tracker</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.14.2.4</td>
            <td class="title-cell"><a href="garbage-collector.html"  class="self">Garbage Collector</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  

  

  



      </div>

      <div class="body-content">
        <div class="page-content">
          <div class="section" id="section_garbage-collector">
  
  <h1 class="section-header"><a class="anchor-target" name="garbage-collector" href="#garbage-collector"></a><span class="section-number">1.14.2.4 </span>Garbage Collector</h1>
  

  <p>Concourse runs everything in isolated environments by creating fresh containers and volumes to ensure things can safely run in a repeatable environment, isolated from other workloads running on the same worker.</p><p>This introduces a new problem of knowing when Concourse should remove these containers and volumes. Safely identifying things for removal and then getting rid of them, releasing their resources, is the process of <em>garbage collection</em>.</p>

  
    
      <div class="section" id="section_goals">
  
  <h2 class="section-header"><a class="anchor-target" name="goals" href="#goals"></a>Goals</h2>
  

  <p>Let&#39;s define our metrics for success:</p><ul>

  <li><p><strong>Safe</strong>. There should never be a case where a build is running and a container or volume is removed out from under it, causing the build to fail. Resource checking should also never result in errors from check containers being removed. No one should even know garbage collection is happening.</p></li>

  <li><p><strong>Airtight</strong>. Everything Concourse creates, whether it&#39;s a container or volume on a worker or an entry in the database, should never leak. Each object should have a fully defined lifecycle such that there is a clear end to its use. The ATC should be interruptible at any point in time and at the very least be able to remove any state it had created beforehand.</p></li>

  <li><p><strong>Resilient</strong>. Garbage collection should never be outpaced by the workload. A single misbehaving worker should not prevent garbage collection from being performed on other workers. A slow delete of a volume should not prevent garbage collecting of other things on the same worker.</p></li>

</ul>

  
    
  
</div>
    
      <div class="section" id="section_how-it-works">
  
  <h2 class="section-header"><a class="anchor-target" name="how-it-works" href="#how-it-works"></a>How it Works</h2>
  

  <p>The garbage collector is a batch operation that runs on an interval with a default of 30 seconds. It&#39;s important to note that the collector must be able to run frequently enough to not be outpaced by the workload producing things, and so the batch operation should be able to complete pretty quickly.</p><p>The batch operation first performs garbage collection within the database alone, removing rows that are no longer needed. The removal of rows from one stage will often result in removals in a later stage. There are individual collectors for each object, such as the volume collector or the container collector, and they are all run asynchronously.</p><p>After the initial pass of garbage collection in the database, there should now be a set of containers and volumes that meet criteria for garbage collection. These two are a bit more complicated to garbage-collect; they both require talking to a worker, and waiting on a potentially slow delete.</p><p>Containers and volumes are the costliest resources consumed by Concourse. There are also many of them created over time as builds execute and pipelines perform their resource checking. Therefore it is important to parallelize this aspect of garbage collection so that one slow delete or one slow worker does not cause them to pile up.</p>

  
    
  
</div>
    
  
</div>

          <nav class="prev-next">
          
            <div class="prev">
              prev:

              
              <span class="section-number">1.14.2.3</span>
              

              <a href="build-tracker.html">Build Tracker</a>
            </div>
          

          
            <div class="next">
              next:

              

              <a href="internals.html#component-tsa">TSA: worker registration &amp; forwarding</a>
            </div>
          
          </nav>
        </div>

        <div class="page-aside"></div>
      </div>
    </div>

    <ul class="improve-docs">
      <li><img src="images/icons/github-box.svg" /> <a href="https://github.com/concourse/docs">help improve this site</a></li>
      <li><img src="images/booklit.svg" /> powered by <a href="https://vito.github.io/booklit">Booklit</a></li>
    </ul>
  </body>
</html>