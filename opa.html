<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=775" />
<title>Open Policy Agent Integration - Concourse CI</title>
<link rel="stylesheet" type="text/css" href="css/normalize.css" />
<link rel="stylesheet" type="text/css" href="css/pipeline.css" />
<link rel="stylesheet" type="text/css" href="css/iosevka.css" />
<link rel="stylesheet" type="text/css" href="css/booklit.css" />
<link rel="stylesheet" type="text/css" href="css/prism.css" />
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
<link href="https://fonts.googleapis.com/css?family=Barlow:400,400i,700|Roboto+Slab:300,400,700" rel="stylesheet" />
<script src="js/search.js"></script>
<script async type="text/javascript" src="js/prism.js"></script>
<script data-goatcounter="https://concourse.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  </head>
  <body>
    

<div class="page-top">
  <nav class="top-nav">
    <a class="top-link logo-link" href="/"><img src="images/logo-white.svg" />Concourse</a>
    
    <a class="top-link active" href="docs.html">Docs</a>
    
    <a class="top-link" href="examples.html">Examples</a>
    
    <a class="top-link" href="project.html">Project</a>
    
    <a class="top-link" href="ecosystem.html">Ecosystem</a>
    
    <a class="top-link" href="support.html">Support</a>
    
    <a class="top-link" href="https://resource-types.concourse-ci.org">Resource Types</a>
    <a class="top-link" href="https://blog.concourse-ci.org">blog</a>

    <div id="search"></div>

    <script type="text/javascript">
      var app = Elm.Main.init({
        node: document.getElementById('search')
      });

      app.ports.emitSearchTerm.subscribe(function(term) {
        goatcounter.count({
          path: "search:" + term,
          title: "user searched: " + term,
          event: true
        });
      });
    </script>
  </nav>
</div>

    <div class="page-body">
      <div class="page-nav">
        






  
  
  
  
  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1</span><a href="docs.html"  class="active">Docs</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.1</td>
            <td class="title-cell"><a href="getting-started.html" >Getting Started</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.2</td>
            <td class="title-cell"><a href="install.html" >Install</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.3</td>
            <td class="title-cell"><a href="auth.html" >Auth &amp; Teams</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.4</td>
            <td class="title-cell"><a href="fly.html" >The <code>fly</code> CLI</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.5</td>
            <td class="title-cell"><a href="config-basics.html" >Config Basics</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.6</td>
            <td class="title-cell"><a href="pipelines.html" >Pipelines</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.7</td>
            <td class="title-cell"><a href="vars.html" >Vars</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.8</td>
            <td class="title-cell"><a href="resources.html" >Resources</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.9</td>
            <td class="title-cell"><a href="resource-types.html" >Resource Types</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.10</td>
            <td class="title-cell"><a href="jobs.html" >Jobs</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.11</td>
            <td class="title-cell"><a href="steps.html" >Steps</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.12</td>
            <td class="title-cell"><a href="tasks.html" >Tasks</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.13</td>
            <td class="title-cell"><a href="builds.html" >Builds</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.14</td>
            <td class="title-cell"><a href="how-to-guides.html" >How-To Guides</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15</td>
            <td class="title-cell"><a href="operation.html"  class="active">Operation</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.16</td>
            <td class="title-cell"><a href="observation.html" >Observation</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.17</td>
            <td class="title-cell"><a href="internals.html" >Internals</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  

  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1.15</span><a href="operation.html"  class="active">Operation</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.15.1</td>
            <td class="title-cell"><a href="metrics.html" >Metrics</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.2</td>
            <td class="title-cell"><a href="tracing.html" >Tracing</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.3</td>
            <td class="title-cell"><a href="encryption.html" >Encryption</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.4</td>
            <td class="title-cell"><a href="creds.html" >Credential Management</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.5</td>
            <td class="title-cell"><a href="security-hardening.html" >Security Hardening</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.6</td>
            <td class="title-cell"><a href="container-placement.html" >Container Placement</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.7</td>
            <td class="title-cell"><a href="opa.html"  class="self">Open Policy Agent Integration</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.8</td>
            <td class="title-cell"><a href="performance-tuning.html" >Performance Tuning</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.9</td>
            <td class="title-cell"><a href="global-resources.html" >Global Resources</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.10</td>
            <td class="title-cell"><a href="administration.html" >Administration</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  

  

  
  <div class="context">
    <nav>
      <div class="top">
        <span class="section-number">1.15.7</span><a href="opa.html"  class="self">Open Policy Agent Integration</a>
      </div>

      <div class="children">
        <table>
        
          <tr>
            <td class="number-cell">1.15.7.1</td>
            <td class="title-cell"><a href="opa.html#configure-opa" >Configuring Concourse</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.7.2</td>
            <td class="title-cell"><a href="opa.html#writing-opa-rules" >Writing OPA Rules</a></td>
          </tr>
        
          <tr>
            <td class="number-cell">1.15.7.3</td>
            <td class="title-cell"><a href="opa.html#special-actions" >Special Actions</a></td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  



      </div>

      <div class="body-content">
        <div class="page-content">
          <div class="section" id="section_opa">
  
  <h1 class="section-header"><a class="anchor-target" name="opa" href="#opa"></a><span class="section-number">1.15.7 </span>Open Policy Agent Integration</h1>
  

  <blockquote class="aside"><p>The <a href="https://www.openpolicyagent.org/docs/latest/">Open Policy Agent</a> (OPA, pronounced “oh-pa”) is an open source, general-purpose policy engine that unifies policy enforcement across the stack.</p></blockquote><p>OPA allows you to create arbitrary rules within Concourse without having to add a new feature to Concourse. You could even recreate Concourse&#39;s <a href="user-roles.html">RBAC system</a> using OPA.</p><p>More likely use-cases are to enforce rules your organization may have, such as not using certain container images or disallowing the use of privileged workloads. With OPA you can be as general or fine-grained as you want, enforcing these rules at the team or pipeline level.</p><p>The next few sections explain how to <a href="opa.html#configure-opa">configure Concourse</a> to talk to an OPA server and how to <a href="opa.html#writing-opa-rules">write OPA rules</a> for Concourse.</p>

  
    
      <div class="section" id="section_configure-opa">
  
  <h2 class="section-header"><a class="anchor-target" name="configure-opa" href="#configure-opa"></a>Configuring Concourse</h2>
  

  <p>There are four configuration options you need to set on the <code>concourse web</code> nodes to have them interact with OPA.</p><ul>

  <li><p><code>CONCOURSE_OPA_URL</code>: The OPA policy check endpoint. Should point to a specific <code>package/rule</code> that contains all Concourse rules for your cluster.</p><p><em>Example:</em> <code>http://opa-endpoint.com/v1/data/concourse/decision</code></p></li>

  <li><p><code>CONCOURSE_POLICY_CHECK_FILTER_HTTP_METHOD</code>: API http methods to go through policy check. You will need to make sure these match up with an API action in the next two configuration options.</p><p><em>Example:</em> <code>PUT,POST</code></p></li>

  <li><p><code>CONCOURSE_POLICY_CHECK_FILTER_ACTION</code>: Actions in this list will go through policy check.</p><p><em>Example:</em> <code>ListWorkers,ListContainers</code></p></li>

  <li><p><code>CONCOURSE_POLICY_CHECK_FILTER_ACTION_SKIP</code>: Actions in this list will not go through policy check</p><p><em>Example:</em> <code>PausePipeline,UnpausePipeline</code></p></li>

</ul><p>For the last three configuration options you can refer to the <a href="https://github.com/concourse/concourse/blob/master/atc/routes.go">this list of routes</a> for a list of API actions and their respective HTTP method. There are also some <a href="opa.html#special-actions">Special Actions</a> not directly in the API.</p>

  
    
  
</div>
    
      <div class="section" id="section_writing-opa-rules">
  
  <h2 class="section-header"><a class="anchor-target" name="writing-opa-rules" href="#writing-opa-rules"></a>Writing OPA Rules</h2>
  

  <p>On the OPA server you&#39;ll need to create a package and policy for Concourse. This should match up with the endpoint provided to Concourse. The <a href="https://www.openpolicyagent.org/docs/latest/">OPA documentation</a> has a good guide explaining how to generally write OPA rules and setup an OPA server.</p><p>For any actions that Concourse has been configured to filter it will send a JSON request to the OPA server with the following details. Top-level data directly under the <code>input</code> key will be present for most actions. The information under the <code>data</code> key will differ based on the action being checked.</p><p>This sample JSON payload is what OPA is sent when a user sets a pipeline. The <code>data</code> key contains the pipeline in JSON format. <pre><code class="language-json">{
  &#34;input&#34;: {
    &#34;service&#34;: &#34;concourse&#34;,
    &#34;cluster_name&#34;: &#34;dev&#34;,
    &#34;cluster_version&#34;: &#34;7.4.0&#34;,
    &#34;http_method&#34;: &#34;PUT&#34;,
    &#34;action&#34;: &#34;SaveConfig&#34;,
    &#34;user&#34;: &#34;test&#34;,
    &#34;team&#34;: &#34;main&#34;,
    &#34;pipeline&#34;: &#34;check-pipeline&#34;,
    &#34;data&#34;: {
      &#34;jobs&#34;: [
        {
          &#34;name&#34;: &#34;test&#34;,
          &#34;plan&#34;: [
            {
              &#34;get&#34;: &#34;tiny&#34;
            },
            {
              &#34;config&#34;: {
                &#34;image_resource&#34;: {
                  &#34;source&#34;: {
                    &#34;repository&#34;: &#34;busybox&#34;
                  },
                  &#34;type&#34;: &#34;registry-image&#34;
                },
                &#34;platform&#34;: &#34;linux&#34;,
                &#34;run&#34;: {
                  &#34;args&#34;: [
                    &#34;-exc&#34;,
                    &#34;echo hello&#34;
                  ],
                  &#34;path&#34;: &#34;sh&#34;
                }
              },
              &#34;task&#34;: &#34;a-task&#34; }
] } ] } } }</code></pre></p><p>An OPA rule can respond to Concourse with three fields:</p><ul>

  <li><p><code>allowed</code> <em>(required)</em>: Boolean type. Setting to <code>False</code> will deny the action unless the <code>block</code> field is <code>False</code>.</p></li>

  <li><p><code>block</code> <em>(optional)</em>: Boolean type. If set to <code>False</code> and <code>allowed</code> is <code>True</code> this creates a soft-policy enforcement. The action will be allowed and the <code>reasons</code> will still be printed to the web UI like a warning message.</p><p>Not setting <code>block</code> is the same as setting <code>&#34;block&#34;: true</code>.</p></li>

  <li><p><code>reasons</code> <em>(optional)</em>: List of string type. If an action is denied based on the <code>allowed</code> field then the reason(s) will be displayed in the UI.</p></li>

</ul><p>Here is an example OPA policy. By default it will allow whatever action it has been sent. It will deny the action if one or more of the three deny rules are true.</p><div class="titled-codeblock">
  <div class="codeblock-title">
    <code>concourse.rego</code>
  </div>

  <pre><code class="language-yaml">package concourse

default decision = {&#34;allowed&#34;: true}

decision = {&#34;allowed&#34;: false, &#34;reasons&#34;: reasons} {
  count(deny) &gt; 0
  reasons := deny
}

deny[&#34;cannot use docker-image types&#34;] {
  input.action == &#34;UseImage&#34;
  input.data.image_type == &#34;docker-image&#34;
}

deny[&#34;cannot run privileged tasks&#34;] {
  input.action == &#34;SaveConfig&#34;
  input.data.jobs[_].plan[_].privileged
}

deny[&#34;cannot use privileged resource types&#34;] {
  input.action == &#34;SaveConfig&#34;
  input.data.resource_types[_].privileged
}</code></pre>
</div>

  
    
  
</div>
    
      <div class="section" id="section_special-actions">
  
  <h2 class="section-header"><a class="anchor-target" name="special-actions" href="#special-actions"></a>Special Actions</h2>
  

  <p>Most of the actions you can filter for come directly from the list of <a href="user-roles.html#action-matrix">API actions</a>. There are currently two special actions you can also filter on.</p>

  
    
      <div class="section" id="section_useimage">
  
  <h3 class="section-header"><a class="anchor-target" name="useimage" href="#useimage"></a><code>UseImage</code></h3>
  

  <p>Before Concourse starts a container you can check what image it is going to use to create the container. Depending on the <code>image_type</code> the <code>image_source</code> field may contain other fields. The JSON payload for this action will look similar to the following example:</p><pre><code class="language-json">{
  &#34;input&#34;: {
    &#34;service&#34;: &#34;concourse&#34;,
    &#34;cluster_name&#34;: &#34;dev&#34;,
    &#34;cluster_version&#34;: &#34;7.4.0&#34;,
    &#34;action&#34;: &#34;UseImage&#34;,
    &#34;team&#34;: &#34;main&#34;,
    &#34;pipeline&#34;: &#34;simple&#34;,
    &#34;data&#34;: {
      &#34;image_type&#34;: &#34;registry-image&#34;,
      &#34;privileged&#34;: true,
      &#34;image_source&#34;: {
        &#34;repository&#34;: &#34;alpine&#34;,
        &#34;tag&#34;: &#34;latest&#34;
      }
    }
  }
}</code></pre>

  
    
  
</div>
    
      <div class="section" id="section_setpipeline">
  
  <h3 class="section-header"><a class="anchor-target" name="setpipeline" href="#setpipeline"></a><code>SetPipeline</code></h3>
  

  <p>This action occurs whenever a <a href="set-pipeline-step.html"><code>set_pipeline</code> step</a> is run. The JSON payload for this action will contain the pipeline config in JSON format under the <code>data</code> key:</p><pre><code class="language-json">{
  &#34;input&#34;: {
    &#34;service&#34;: &#34;concourse&#34;,
    &#34;cluster_name&#34;: &#34;dev&#34;,
    &#34;cluster_version&#34;: &#34;7.4.0&#34;,
    &#34;action&#34;: &#34;SetPipeline&#34;,
    &#34;team&#34;: &#34;main&#34;,
    &#34;pipeline&#34;: &#34;simple&#34;,
    &#34;data&#34;: {
      &#34;jobs&#34;: [
        {
          &#34;name&#34;: &#34;test&#34;,
          &#34;plan&#34;: [
            {
              &#34;get&#34;: &#34;tiny&#34;
            },
            {
              &#34;config&#34;: {
                &#34;image_resource&#34;: {
                  &#34;source&#34;: {
                    &#34;repository&#34;: &#34;busybox&#34;
                  },
                  &#34;type&#34;: &#34;registry-image&#34;
                },
                &#34;platform&#34;: &#34;linux&#34;,
                &#34;run&#34;: {
                  &#34;args&#34;: [
                    &#34;-exc&#34;,
                    &#34;echo hello&#34;
                  ],
                  &#34;path&#34;: &#34;sh&#34;
                }
              },
              &#34;task&#34;: &#34;a-task&#34; }
] } ] } } }</code></pre>

  
    
  
</div>
    
  
</div>
    
  
</div>

          <nav class="prev-next">
          
            <div class="prev">
              prev:

              
              <span class="section-number">1.15.6</span>
              

              <a href="container-placement.html">Container Placement</a>
            </div>
          

          
            <div class="next">
              next:

              
              <span class="section-number">1.15.8</span>
              

              <a href="performance-tuning.html">Performance Tuning</a>
            </div>
          
          </nav>
        </div>

        <div class="page-aside"></div>
      </div>
    </div>

    <ul class="improve-docs">
      <li><img src="images/icons/github-box.svg" /> <a href="https://github.com/concourse/docs">help improve this site</a></li>
      <li><img src="images/booklit.svg" /> powered by <a href="https://vito.github.io/booklit">Booklit</a></li>
    </ul>
  </body>
</html>